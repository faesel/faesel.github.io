1:"$Sreact.fragment"
3:I[22016,["/_next/static/chunks/8be72f203fe36d6f.js"],""]
4:I[5500,["/_next/static/chunks/8be72f203fe36d6f.js"],"Image"]
9:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/708205fa81a1891d.js"],"OutletBoundary"]
a:"$Sreact.suspense"
:HL["/_next/static/chunks/bc2ec6988ea822be.css","style"]
2:T450,{"@context":"https://schema.org","@type":"BlogPosting","headline":"ASP.NET GraphQL server with Hot Chocolate","description":"# Starting my journey with GraphQL\n\nUp till now, I've always heavily relied on RESTfull services to power API's, this recently got widened with GRPC which you c","image":"https://images.ctfassets.net/wjg1udsw901v/74JrRnpexhOnSAsBwNOPV7/635bc389cea0de36f3158df45483ae85/graphql.jpg","datePublished":"2021-04-05T00:00+01:00","dateModified":"2021-04-05T00:00+01:00","author":{"@type":"Person","name":"Faesel Saeed","url":"https://www.faesel.com/about"},"publisher":{"@type":"Organization","name":"Faesel Saeed","url":"https://www.faesel.com","logo":{"@type":"ImageObject","url":"https://www.faesel.com/images/logo.png"}},"keywords":"graphql, hotchocolate, graphql-voyager, asp.net, authentication, authorization, versioning, rest, chilli-cream, logging, open-telemetry, banana-cake-pop","url":"https://www.faesel.com/blog/aspnet-graphql-server-with-hot-chocolate","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.faesel.com/blog/aspnet-graphql-server-with-hot-chocolate"}}0:{"buildId":"GRQ4Wn3Dp8FngowyVAxrt","rsc":["$","$1","c",{"children":[[["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"$2"}}],["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BreadcrumbList\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https://www.faesel.com\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Blog\",\"item\":\"https://www.faesel.com/blog\"},{\"@type\":\"ListItem\",\"position\":3,\"name\":\"ASP.NET GraphQL server with Hot Chocolate\",\"item\":\"https://www.faesel.com/blog/aspnet-graphql-server-with-hot-chocolate\"}]}"}}],["$","article",null,{"className":"page-module__dgei_G__article","children":[["$","$L3",null,{"href":"/blog","className":"page-module__dgei_G__backLink","children":"‚Üê Back to Blog"}],["$","header",null,{"className":"page-module__dgei_G__header","children":[["$","h1",null,{"className":"page-module__dgei_G__title","children":"ASP.NET GraphQL server with Hot Chocolate"}],["$","div",null,{"className":"page-module__dgei_G__meta","children":["$","time",null,{"className":"page-module__dgei_G__date","dateTime":"2021-04-05T00:00+01:00","children":["üìÖ ","April 4, 2021"]}]}],["$","div",null,{"className":"page-module__dgei_G__tags","children":[["$","span","graphql-0",{"className":"page-module__dgei_G__tag","children":"graphql"}],["$","span","hotchocolate-1",{"className":"page-module__dgei_G__tag","children":"hotchocolate"}],["$","span","graphql-voyager-2",{"className":"page-module__dgei_G__tag","children":"graphql-voyager"}],["$","span","asp.net-3",{"className":"page-module__dgei_G__tag","children":"asp.net"}],["$","span","authentication-4",{"className":"page-module__dgei_G__tag","children":"authentication"}],["$","span","authorization-5",{"className":"page-module__dgei_G__tag","children":"authorization"}],["$","span","versioning-6",{"className":"page-module__dgei_G__tag","children":"versioning"}],["$","span","rest-7",{"className":"page-module__dgei_G__tag","children":"rest"}],["$","span","chilli-cream-8",{"className":"page-module__dgei_G__tag","children":"chilli-cream"}],["$","span","logging-9",{"className":"page-module__dgei_G__tag","children":"logging"}],["$","span","open-telemetry-10",{"className":"page-module__dgei_G__tag","children":"open-telemetry"}],["$","span","banana-cake-pop-11",{"className":"page-module__dgei_G__tag","children":"banana-cake-pop"}]]}]]}],["$","div",null,{"className":"page-module__dgei_G__heroImage","children":["$","$L4",null,{"src":"https://images.ctfassets.net/wjg1udsw901v/74JrRnpexhOnSAsBwNOPV7/635bc389cea0de36f3158df45483ae85/graphql.jpg","alt":"ASP.NET GraphQL server with Hot Chocolate","fill":true,"className":"page-module__dgei_G__heroImageImg","priority":true,"sizes":"(max-width: 800px) 100vw, 800px"}]}],"$L5"]}]],["$L6"],"$L7"]}],"loading":null,"isPartial":false}
8:Tddcd,<h1>Starting my journey with GraphQL</h1>
<p>Up till now, I&#39;ve always heavily relied on RESTfull services to power API&#39;s, this recently got widened with GRPC which you can read about in my article <a href="https://www.faesel.com/blog/dotnet-grpc-forgot-to-tell-you">.NET &amp; GRPC What they forgot to tell you</a>. GraphQL was the third final frontier that needed exploring ü•æ...until now.</p>
<p>Having looked at it a year back the implementations for .NET were in their infancy, which meant that your server would only be as good as the framework you choose. Fast forward to 2021, <a href="https://github.com/ChilliCream/hotchocolate">Chilli Creams Hotchocolate</a> has gained some serious ground and makes GraphQL an appealing proposition for developers.</p>
<p>In this article I hope to cover two main points,</p>
<ul>
<li>How REST is designed to break backend engineers</li>
<li>How GraphQL saves the day</li>
</ul>
<h1>Your typical REST scenario</h1>
<p>Let&#39;s paint the scene, your a backend engineer who&#39;s creating an endpoint for showing a list of cats. With your battle-tested REST knowledge, you set out to create your first basic endpoint in the <code>CatsController</code> that returns all cats and the front end engineer is ready to integrate it into his UI.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-comment">// api/cats</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">[<span class="hljs-meta">HttpGet</span>]</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetCats</span>()</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = contextFactory.CreateDbContext())</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">        <span class="hljs-keyword">var</span> cats = <span class="hljs-keyword">await</span> context.Cats.ToListAsync();</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        <span class="hljs-keyword">if</span>(cat != <span class="hljs-literal">null</span>)</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">            <span class="hljs-keyword">return</span> Ok(cats);</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    <span class="hljs-keyword">return</span> NoContent();</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">}</span></span></code></pre><p>The app soon becomes a hit! your product manager decides to expand the functionality to filter by cat descriptions and to create a new cat information page. Getting to work you expand the endpoints for the front end engineers to use.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-comment">//api/cats/1</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">[<span class="hljs-meta">HttpGet</span>]</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">[<span class="hljs-meta">Route(<span class="hljs-string">&quot;{id}&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetCatsById</span>(<span class="hljs-params">[FromRoute] <span class="hljs-built_in">int</span> id</span>)</span></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = contextFactory.CreateDbContext())</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">        <span class="hljs-keyword">var</span> cats = <span class="hljs-keyword">await</span> context.Cats.FirstOrDefaultAsync(x =&gt; x.Id == id);</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">        <span class="hljs-keyword">if</span>(cats != <span class="hljs-literal">null</span>)</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">            <span class="hljs-keyword">return</span> Ok(cats);</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    <span class="hljs-keyword">return</span> NoContent();</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content"><span class="hljs-comment">// api/cats/description/brown</span></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">[<span class="hljs-meta">HttpGet</span>]</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">[<span class="hljs-meta">Route(<span class="hljs-string">&quot;description/{description}&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetCatsByDescription</span>(<span class="hljs-params">[FromRoute] <span class="hljs-built_in">string</span> description</span>)</span></span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = contextFactory.CreateDbContext())</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">        <span class="hljs-keyword">var</span> cats = <span class="hljs-keyword">await</span> context.Cats.Where(x =&gt; x.Description.Contains(description)).ToListAsync();</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">        <span class="hljs-keyword">if</span>(cats != <span class="hljs-literal">null</span>)</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">            <span class="hljs-keyword">return</span> Ok(payload);</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content">    <span class="hljs-keyword">return</span> NoContent();</span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content">}</span></span></code></pre><p>The cycle continues with product owners coming up with more feature requests and at the bottom of the pile, you got the backend engineer being reactive to all the changes. By the time you&#39;ve wrapped up the project your left with a code smell of 10+ endpoints üí©.</p>
<p>The situation further degrades after a year when the UI gets redesigned and features are culled based on user usage. You end up with random floating endpoints because quite frankly no one audits their endpoints for dead code.</p>
<p>This is where GraphQL steps in, it switches the responsibility of an engineer from anticipating and creating endpoints to simply upfront displaying everything that&#39;s available with declarative meaning.</p>
<h1>Hot Chocolate (.NET GraphQL server framework)</h1>
<p>Hot chocolate is one of the leading implementations of a GraphQL server, one important thing to note when choosing a framework is that your implementation will only be as good as the framework you choose. As the <a href="http://spec.graphql.org/">GraphQL specification</a> progresses you want a framework that keeps up to date with the changes... Hot Chocolate does that.</p>
<p>To understand the basics of Hot Chocolate I recommend <a href="https://www.youtube.com/user/binarythistle"><strong>Les Jackson&#39;s</strong></a> free course on youtube. It is a bit lengthy at 3 Hours and 45 Minutes but it allows you to create an ASP.NET implementation from scratch and understand basic concepts like Querys, Mutations and Subscriptions. By the end of the course, you have a GraphQL service that can do CRUD actions (do üëç his video it&#39;s great!).</p>
<p><a href="https://www.youtube.com/watch?v=HuN94qNwQmM">https://www.youtube.com/watch?v=HuN94qNwQmM</a></p>
<p>The source code he produces can also be found on his <a href="https://github.com/binarythistle/S04E01---.NET-5-GraphQL-API">github repo</a>. The source code is a great starting point as it creates a docker image containing an MSSQL database. The solution itself already has Entity Framework and Hot Chocolate bootstrapped, with two entities to test with.</p>
<p>On top of this <a href="https://github.com/ChilliCream/hotchocolate/blob/main/src/BananaCakePop">Banana Cake Pop üçå</a> is also integrated which allows you to query your server through a browser (similar to swagger).</p>
<p>As well as <a href="https://github.com/APIs-guru/graphql-voyager">GraphQL Voyager üöÄ</a> (do checkout the <a href="https://apis.guru/graphql-voyager/">live demo</a>).</p>
<p>To understand the remainder of the article it&#39;s important to have some basic knowledge of Hot Chocolate.</p>
<h1>GraphQl Voyager</h1>
<p>Whilst this is an addition to what&#39;s being discussed, it&#39;s worth briefly mentioning. Voyager helps facilitate the move of a backend engineer from creating and documenting prescriptive REST endpoints to simply becoming a harbour of documentation and entities.</p>
<blockquote>
<p>The marker of a quality API has shifted from creating a subjectively RESTfull API and how well it&#39;s documented to ... just how well it&#39;s documented üìù.</p>
</blockquote>
<p>Here&#39;s a taste of what is looks like for our API,</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/8f7Kb65mDXS5ZBSA4At50/08bcdb6bfe661bdb50965e7b9e8d5a81/graphql-voyager.png" alt="Graphql Voyager"></p>
<h1>What they forgot to mention</h1>
<p>Up till now what we have discussed fits the 80% CRUD usecase, however as we know API&#39;s that are in the wild also deal with a range of other responsibilities. The remainder of this article is to shed some light on how this is done.</p>
<h2>How to version your API</h2>
<p>The typical versioning strategy for REST is to version using URLs <code>https://api.cats.com/v1</code> (when developers can be bothered). However with GraphQL as your only ever posting to a single endpoint that strategy is no longer a prefered solution.</p>
<blockquote>
<p>While there&#39;s nothing that prevents a GraphQL service from being versioned just like any other REST API, GraphQL takes a strong opinion on avoiding versioning by providing the tools for the continuous evolution of a GraphQL schema.<br><em><a href="https://graphql.org/learn/best-practices/">Taken from GraphQL Best Practices</a></em></p>
</blockquote>
<p>Before we begin on how to version, there are some distinct points to note.</p>
<p>Non-breaking changes can continue as they would with REST, adding properties to entities (as you would with response models in REST), continues to be a way to evolve your API. Similarly adding new query types to your GraphQL server is also deemed as a non-breaking change, and is equivalent to adding new endpoints in REST.</p>
<p>GraphQL aids in breaking changes caused due to nullability as <strong>everything</strong> unless specified is treated as nullable. This leads to upfront resilience on the front end to missing data, the <code>id: Int!</code> in the example below cannot be null.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">type</span> <span class="hljs-type">Cats</span> {</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  id: <span class="hljs-type">Int</span>!</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">  name: <span class="hljs-type">String</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">}</span></span></code></pre><p>Eventually, we do still hit circumstances where a breaking change is needed. In these situations we have two strategies. The first as <a href="https://chillicream.com/docs/hotchocolate/defining-a-schema/versioning/">Chilli Cream Docs</a> specify is to add deprecated flags to old properties and begin to shift usage to new versions.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">public class CatsType : ObjectType&lt;Cats&gt;</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    <span class="hljs-keyword">protected</span> override <span class="hljs-type">void</span> Configure(IObjectTypeDescriptor&lt;Cats&gt; descriptor)</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">        descriptor.Description(<span class="hljs-string">&quot;Represents commands available on a platform&quot;</span>)<span class="hljs-comment">;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">        descriptor.Field(<span class="hljs-keyword">x</span> <span class="hljs-operator">=</span>&gt; <span class="hljs-keyword">x</span>.Name).Deprecated(<span class="hljs-string">&quot;This is no longer used, use FirstName and LastName&quot;</span>)<span class="hljs-comment">;</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        descriptor.Field(<span class="hljs-keyword">x</span> <span class="hljs-operator">=</span>&gt; <span class="hljs-keyword">x</span>.FirstName)<span class="hljs-comment">;</span></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">        descriptor.Field(<span class="hljs-keyword">x</span> <span class="hljs-operator">=</span>&gt; <span class="hljs-keyword">x</span>.LastName)<span class="hljs-comment">;</span></span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">}</span></span></code></pre><p>For client developers, this then creates warnings when using a deprecated property.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/2BkWWBcz1UAAU9fFVavBGQ/c812ee032ddcd8eb600b165616f68e5b/Screenshot_2021-03-26_153337.png" alt="Depricated GraphQL property"></p>
<p>Whilst this approach works over time it could create a lot of noise if you have many deprecated properties, an alternative approach is to split the entity entirely, use different classes between the two versions. Here is an example, we start by creating two query types,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">CatResponse1</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> Id, <span class="hljs-built_in">string</span> Name</span>)</span>;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">CatResponse2</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> Id, <span class="hljs-built_in">string</span> FirstName, <span class="hljs-built_in">string</span> LastName</span>)</span>;</span></span></code></pre><p>Both of these would contain their own Code First type files</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CatType1</span> : <span class="hljs-title">ObjectType</span>&lt;<span class="hljs-title">CatResponse1</span>&gt;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IObjectTypeDescriptor&lt;CatResponse1&gt; descriptor</span>)</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">        descriptor.Description(<span class="hljs-string">&quot;Represents cats!&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">        descriptor.Field(x =&gt; x.Name)</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">            .Description(<span class="hljs-string">&quot;Represents the name of the cat&quot;</span>)</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">            .Deprecated(<span class="hljs-string">&quot;This is no longer used, use FirstName and LastName from Cat2&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CatType2</span> : <span class="hljs-title">ObjectType</span>&lt;<span class="hljs-title">CatResponse2</span>&gt;</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IObjectTypeDescriptor&lt;CatResponse2&gt; descriptor</span>)</span></span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">        descriptor.Description(<span class="hljs-string">&quot;Represents cats!&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        descriptor.Field(x =&gt; x.FirstName)</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">            .Description(<span class="hljs-string">&quot;Represents the name firstname of the cat&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">        descriptor.Field(x =&gt; x.LastName)</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">            .Description(<span class="hljs-string">&quot;Represents the name lastname of the cat&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">}</span></span></code></pre><p>The final piece of code is to use the intermediary response models. Under the hood we are still using the same EF entity.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Query</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    [<span class="hljs-meta">UseDbContext(typeof(AppDbContext))</span>]</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    [<span class="hljs-meta">UseFiltering</span>]</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    [<span class="hljs-meta">UseSorting</span>]</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> IQueryable&lt;CatResponse1&gt; <span class="hljs-title">GetCat1</span>(<span class="hljs-params">[ScopedService] AppDbContext context</span>)</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">        <span class="hljs-keyword">var</span> cats = context.Cats;</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">        <span class="hljs-keyword">return</span> cats.Select(x =&gt; <span class="hljs-keyword">new</span> CatResponse1(x.Id, x.Name));</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    [<span class="hljs-meta">UseDbContext(typeof(AppDbContext))</span>]</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    [<span class="hljs-meta">UseFiltering</span>]</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    [<span class="hljs-meta">UseSorting</span>]</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> IQueryable&lt;CatResponse2&gt; <span class="hljs-title">GetCat2</span>(<span class="hljs-params">[ScopedService] AppDbContext context</span>)</span></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">        <span class="hljs-keyword">var</span> cats = context.Cats;</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        <span class="hljs-keyword">return</span> cats.Select(x =&gt; <span class="hljs-keyword">new</span> CatResponse2(x.Id, x.FirstName, x.LastName));</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content"></span></span></code></pre><p>These changes now allow us to split our models, the two can be queried independently.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/4RSPAHISSIpKS3qFfZbRq1/b53386073d0e86bc0e14a95b30ff857a/versioned-entities.png" alt="Versioned types"></p>
<h2>How to do Authentication</h2>
<p>Since Hot Chocolate works on top of ASP.NET we can leverage on all the traditional Authentication pipelines we use for REST, nothing changes! To demonstrate this I&#39;m going to extend the base implementation with a basic authentication mechanism using a header value <code>x-api-key</code> and a key defined in the <code>appsettings.json</code>.</p>
<h3>Adding key-based authentication</h3>
<p>To begin let&#39;s first add basic app settings to hold our authentication key (this represents the key the client will pass to the server to authentication their request), and create a class to deserialise into using <code>IOptions</code> interface.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">//Code goes <span class="hljs-keyword">into</span> appsettings.json</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">&quot;AuthenticationSettings&quot;: {</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    &quot;AuthenticationToken&quot;: &quot;secret123&quot;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">//<span class="hljs-built_in">New</span> <span class="hljs-keyword">class</span> <span class="hljs-keyword">to</span> serialize <span class="hljs-keyword">into</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> AuthenticationSettings</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">    <span class="hljs-built_in">public</span> string AuthenticationToken { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">//Register the <span class="hljs-keyword">configuration</span> <span class="hljs-keyword">in</span> Startup.cs &gt; ConfigureServices <span class="hljs-keyword">function</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">services.Configure&lt;AuthenticationSettings&gt;(<span class="hljs-keyword">Configuration</span>.GetSection(nameof(AuthenticationSettings)));</span></span></code></pre><p>Next we will create authentication scheme options as follows,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">ApiKeyAuthenticationOptions</span> : <span class="hljs-symbol">AuthenticationSchemeOptions</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> DefaultScheme = <span class="hljs-string">&quot;KeyBasedScheme&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Scheme =&gt; DefaultScheme;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> AuthenticationType = DefaultScheme;</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">}</span></span></code></pre><p>The next part is where the crux of the code is, the <code>AuthenticationHandler</code> is what determines whether the request was correctly authenticated. On a successful attempt, it populates the ClaimsPrinciple.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApiKeyAuthenticationHandler</span> : <span class="hljs-title">AuthenticationHandler</span>&lt;<span class="hljs-title">ApiKeyAuthenticationOptions</span>&gt;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> ProblemDetailsContentType = <span class="hljs-string">&quot;application/problem+json&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> AuthenticationHeaderName = <span class="hljs-string">&quot;x-api-key&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AuthenticationSettings AuthenticationSettings;</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ApiKeyAuthenticationHandler</span>(<span class="hljs-params"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">        IOptionsMonitor&lt;ApiKeyAuthenticationOptions&gt; options,</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        ILoggerFactory logger,</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">        UrlEncoder encoder,</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">        ISystemClock clock,</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        IOptions&lt;AuthenticationSettings&gt; authenticationSettings</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options, logger, encoder, clock</span>)</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">        AuthenticationSettings = authenticationSettings.Value;</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task&lt;AuthenticateResult&gt; <span class="hljs-title">HandleAuthenticateAsync</span>()</span></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        <span class="hljs-keyword">if</span> (!Request.Headers.TryGetValue(AuthenticationHeaderName, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> apiKeyHeaderValues))</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">            <span class="hljs-keyword">return</span> Task.FromResult(AuthenticateResult.NoResult());</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">        <span class="hljs-keyword">var</span> providedApiKey = apiKeyHeaderValues.FirstOrDefault();</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">        <span class="hljs-keyword">if</span> (apiKeyHeaderValues.Count == <span class="hljs-number">0</span> || <span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(providedApiKey))</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">            <span class="hljs-keyword">return</span> Task.FromResult(AuthenticateResult.NoResult());</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content">        <span class="hljs-keyword">var</span> isMatchingKey = providedApiKey.Equals(AuthenticationSettings.AuthenticationToken);</span></span>
<span class="code-line"><span class="line-number">32</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">33</span><span class="line-content">        <span class="hljs-keyword">if</span> (isMatchingKey)</span></span>
<span class="code-line"><span class="line-number">34</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">35</span><span class="line-content">            <span class="hljs-keyword">var</span> claims = <span class="hljs-keyword">new</span> List&lt;Claim&gt; {</span></span>
<span class="code-line"><span class="line-number">36</span><span class="line-content">                <span class="hljs-comment">//Add your claims here</span></span></span>
<span class="code-line"><span class="line-number">37</span><span class="line-content">            };</span></span>
<span class="code-line"><span class="line-number">38</span><span class="line-content">            <span class="hljs-keyword">var</span> identity = <span class="hljs-keyword">new</span> ClaimsIdentity(claims, Options.AuthenticationType);</span></span>
<span class="code-line"><span class="line-number">39</span><span class="line-content">            <span class="hljs-keyword">var</span> identities = <span class="hljs-keyword">new</span> List&lt;ClaimsIdentity&gt; { identity };</span></span>
<span class="code-line"><span class="line-number">40</span><span class="line-content">            <span class="hljs-keyword">var</span> principal = <span class="hljs-keyword">new</span> ClaimsPrincipal(identities);</span></span>
<span class="code-line"><span class="line-number">41</span><span class="line-content">            <span class="hljs-keyword">var</span> ticket = <span class="hljs-keyword">new</span> AuthenticationTicket(principal, Options.Scheme);</span></span>
<span class="code-line"><span class="line-number">42</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">43</span><span class="line-content">            <span class="hljs-keyword">return</span> Task.FromResult(AuthenticateResult.Success(ticket));</span></span>
<span class="code-line"><span class="line-number">44</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">45</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">46</span><span class="line-content">        <span class="hljs-keyword">return</span> Task.FromResult(AuthenticateResult.Fail(<span class="hljs-string">&quot;Invalid API Key provided.&quot;</span>));</span></span>
<span class="code-line"><span class="line-number">47</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">48</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">49</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleChallengeAsync</span>(<span class="hljs-params">AuthenticationProperties properties</span>)</span></span></span>
<span class="code-line"><span class="line-number">50</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">51</span><span class="line-content">        Response.StatusCode = (<span class="hljs-built_in">int</span>)HttpStatusCode.Unauthorized;</span></span>
<span class="code-line"><span class="line-number">52</span><span class="line-content">        Response.ContentType = ProblemDetailsContentType;</span></span>
<span class="code-line"><span class="line-number">53</span><span class="line-content">        <span class="hljs-keyword">var</span> problemDetails = <span class="hljs-keyword">new</span> { Information = <span class="hljs-string">&quot;Unauthorized&quot;</span> };</span></span>
<span class="code-line"><span class="line-number">54</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">55</span><span class="line-content">        <span class="hljs-keyword">await</span> Response.WriteAsync(JsonSerializer.Serialize(problemDetails));</span></span>
<span class="code-line"><span class="line-number">56</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">57</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">58</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HandleForbiddenAsync</span>(<span class="hljs-params">AuthenticationProperties properties</span>)</span></span></span>
<span class="code-line"><span class="line-number">59</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">60</span><span class="line-content">        Response.StatusCode = (<span class="hljs-built_in">int</span>)HttpStatusCode.Forbidden;</span></span>
<span class="code-line"><span class="line-number">61</span><span class="line-content">        Response.ContentType = ProblemDetailsContentType;</span></span>
<span class="code-line"><span class="line-number">62</span><span class="line-content">        <span class="hljs-keyword">var</span> problemDetails = <span class="hljs-keyword">new</span> { Information = <span class="hljs-string">&quot;Forbidden&quot;</span> };</span></span>
<span class="code-line"><span class="line-number">63</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">64</span><span class="line-content">        <span class="hljs-keyword">await</span> Response.WriteAsync(JsonSerializer.Serialize(problemDetails));</span></span>
<span class="code-line"><span class="line-number">65</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">66</span><span class="line-content">}</span></span></code></pre><p>The final part need is to register this in our startup class, below are the two bits of code needed. Once we have this in place the <code>[Authorize]</code> tag will work for regular REST requests, any request sent without an <code>x-api-key</code> value of &#39;secret123&#39; will be rejected. The next step is to see how we replicate this in GraphQL.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">public void <span class="hljs-built_in">ConfigureServices</span>(IServiceCollection services)</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    ...</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    services<span class="hljs-selector-class">.AddAuthentication</span>(options =&gt;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">        options.DefaultAuthenticateScheme = ApiKeyAuthenticationOptions.DefaultScheme;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">        options.DefaultChallengeScheme = ApiKeyAuthenticationOptions.DefaultScheme;</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">    })<span class="hljs-selector-class">.AddScheme</span>&lt;ApiKeyAuthenticationOptions, ApiKeyAuthenticationHandler&gt;(</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        ApiKeyAuthenticationOptions.DefaultScheme,</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">        null</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    );</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">    services<span class="hljs-selector-class">.AddAuthorization</span>();</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">public void <span class="hljs-built_in">Configure</span>(IApplicationBuilder app, IWebHostEnvironment env)</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">    ...</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    app<span class="hljs-selector-class">.UseAuthentication</span>();</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">    app<span class="hljs-selector-class">.UseAuthorization</span>();</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">}</span></span></code></pre><h3>Authenticating a GraphQl Entity</h3>
<p>Authentication in GraphQL works by authorizing individual models, to begin we first need to add the HotChocolate Authorization package <code>HotChocolate.AspNetCore.Authorization</code> and enable it in the <code>Startup.cs</code> class, its a one-liner,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">services<span class="hljs-selector-class">.AddAuthorizeDirectiveType</span>()</span></span></code></pre><p>Now similar to the <code>[Authorize]</code> tag we use for REST we can enable Authorization in for our individual ObjectTypes by adding a simple <code>descriptor.Authorize()</code> call.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">CatType1</span> : <span class="hljs-symbol">ObjectType</span>&lt;<span class="hljs-symbol">CatResponse1</span>&gt;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">void</span> Configure(IObjectTypeDescriptor&lt;CatResponse1&gt; descriptor)</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">        descriptor.Authorize();</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">        ...</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">}</span></span></code></pre><p>Once this has been added making calls without the header will return an unauthenticated result that looks like this,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  &quot;errors&quot;: [</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">      &quot;message&quot;: <span class="hljs-string">&quot;The current user is not authorized to access this resource.&quot;</span>,</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">      <span class="hljs-string">&quot;locations&quot;</span>: [</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">          &quot;<span class="hljs-selector-tag">line</span>&quot;: <span class="hljs-number">3</span>,</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">          <span class="hljs-string">&quot;column&quot;</span>: <span class="hljs-number">5</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">      ],</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">      &quot;<span class="hljs-selector-tag">path</span>&quot;: [</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        <span class="hljs-string">&quot;cat1&quot;</span>,</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">        <span class="hljs-number">1</span>,</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">        <span class="hljs-string">&quot;id&quot;</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">      ],</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">      <span class="hljs-string">&quot;extensions&quot;</span>: {</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">        &quot;<span class="hljs-selector-tag">code</span>&quot;: <span class="hljs-string">&quot;AUTH_NOT_AUTHENTICATED&quot;</span></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">      }</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">    },</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">    ...</span></span></code></pre><h2>How to do Authorisation</h2>
<p>Extending the code to work with Authorization is also a quick change, in this example we will authorize based on the user&#39;s role. To begin we will extend our <code>ApiKeyAuthenticationHandler</code> to populate a claim when the authentication key has matched,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">var</span> claims = <span class="hljs-keyword">new</span> List&lt;Claim&gt; {</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">    <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span>, <span class="hljs-string">&quot;Admin&quot;</span>)</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">};</span></span></code></pre><p>Next we can pass a list of accepted roles into the ObjectType <code>CatType1</code>, in this example I have intentionally added a role that doesn&#39;t exist.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">var roles <span class="hljs-operator">=</span> new string[] { <span class="hljs-string">&quot;NotAdmin&quot;</span> }<span class="hljs-comment">;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">descriptor.Authorize(roles)<span class="hljs-comment">;</span></span></span></code></pre><p>Making a request now will spark an unauthorized error,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  &quot;errors&quot;: [</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">      &quot;message&quot;: <span class="hljs-string">&quot;The current user is not authorized to access this resource.&quot;</span>,</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">      <span class="hljs-string">&quot;locations&quot;</span>: [</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">          &quot;<span class="hljs-selector-tag">line</span>&quot;: <span class="hljs-number">3</span>,</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">          <span class="hljs-string">&quot;column&quot;</span>: <span class="hljs-number">5</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">      ],</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">      &quot;<span class="hljs-selector-tag">path</span>&quot;: [</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        <span class="hljs-string">&quot;cat1&quot;</span>,</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">        <span class="hljs-number">1</span>,</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">        <span class="hljs-string">&quot;id&quot;</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">      ],</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">      <span class="hljs-string">&quot;extensions&quot;</span>: {</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">        &quot;<span class="hljs-selector-tag">code</span>&quot;: <span class="hljs-string">&quot;AUTH_NOT_AUTHORIZED&quot;</span></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">      }</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">    },</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">    ...</span></span></code></pre><h2>How does logging work</h2>
<p>Regarding logging Chilli Cream has created a guide to adding an <code>AddDiagnosticEventListener</code> that&#39;s able to trace incoming requests, check out the article <a href="https://chillicream.com/blog/2021/01/10/hot-chocolate-logging">Log Your Queries While Building a GraphQL Server</a>. It would be interesting to create an example that&#39;s <code>OpenTelemetry</code> compliant... perhaps that&#39;s one for another day (this articles getting a bit long üò©).</p>
<h1>Conclusion</h1>
<p>That&#39;s it folks! We&#39;ve seen that the Hot Chocolate implementation nicely fulfils not just the 80% crud use case but can also deal with the other responsibilities we typically see with our REST services in the wild.</p>
5:["$","div",null,{"className":"page-module__dgei_G__content","dangerouslySetInnerHTML":{"__html":"$8"}}]
6:["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/bc2ec6988ea822be.css","precedence":"next"}]
7:["$","$L9",null,{"children":["$","$a",null,{"name":"Next.MetadataOutlet","children":"$@b"}]}]
b:null
