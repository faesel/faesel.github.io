1:"$Sreact.fragment"
3:I[22016,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],""]
4:I[5500,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],"Image"]
b:I[23150,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],"default"]
d:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/708205fa81a1891d.js"],"OutletBoundary"]
e:"$Sreact.suspense"
:HL["/_next/static/chunks/4c98436a675d5713.css","style"]
2:T416,{"@context":"https://schema.org","@type":"BlogPosting","headline":"Adding environments to ASP.NET Core with React.js SPA","description":"Recently I started working on a project that was created from the **ASP.NET SPA template for react**. It's one of the templates you get by default with dotnet a","image":"https://images.ctfassets.net/wjg1udsw901v/1IeybLQIjDnbaXTl4sbqTn/294b0ef4ad9095ee3633f6c38a0e35aa/hero.png","datePublished":"2021-01-19T00:00+00:00","dateModified":"2021-01-19T00:00+00:00","author":{"@type":"Person","name":"Faesel Saeed","url":"https://www.faesel.com/about"},"publisher":{"@type":"Organization","name":"Faesel Saeed","url":"https://www.faesel.com","logo":{"@type":"ImageObject","url":"https://www.faesel.com/images/logo.png"}},"keywords":"react, spa, asp.net, dotnet core, environments, env-cmd, shx, template, msbuild, .env","url":"https://www.faesel.com/blog/aspnet-core-react-spa-adding-environments","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.faesel.com/blog/aspnet-core-react-spa-adding-environments"}}0:{"buildId":"HpwxYzBaBElmpEhE8BM51","rsc":["$","$1","c",{"children":[[["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"$2"}}],["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BreadcrumbList\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https://www.faesel.com\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Blog\",\"item\":\"https://www.faesel.com/blog\"},{\"@type\":\"ListItem\",\"position\":3,\"name\":\"Adding environments to ASP.NET Core with React.js SPA\",\"item\":\"https://www.faesel.com/blog/aspnet-core-react-spa-adding-environments\"}]}"}}],["$","article",null,{"className":"page-module__dgei_G__article","children":[["$","$L3",null,{"href":"/blog","className":"page-module__dgei_G__backLink","children":"‚Üê Back to Blog"}],["$","header",null,{"className":"page-module__dgei_G__header","children":[["$","h1",null,{"className":"page-module__dgei_G__title","children":"Adding environments to ASP.NET Core with React.js SPA"}],["$","div",null,{"className":"page-module__dgei_G__meta","children":[["$","time",null,{"className":"page-module__dgei_G__date","dateTime":"2021-01-19T00:00+00:00","children":["üìÖ ","January 19, 2021"]}],["$","span",null,{"className":"page-module__dgei_G__separator","children":"‚Ä¢"}],["$","span",null,{"className":"page-module__dgei_G__readingTime","children":["‚è±Ô∏è ","8 min read"]}]]}],["$","div",null,{"className":"page-module__dgei_G__tags","children":[["$","span","react-0",{"className":"page-module__dgei_G__tag","children":"react"}],["$","span","spa-1",{"className":"page-module__dgei_G__tag","children":"spa"}],["$","span","asp.net-2",{"className":"page-module__dgei_G__tag","children":"asp.net"}],["$","span","dotnet core-3",{"className":"page-module__dgei_G__tag","children":"dotnet core"}],["$","span","environments-4",{"className":"page-module__dgei_G__tag","children":"environments"}],["$","span","env-cmd-5",{"className":"page-module__dgei_G__tag","children":"env-cmd"}],["$","span","shx-6",{"className":"page-module__dgei_G__tag","children":"shx"}],["$","span","template-7",{"className":"page-module__dgei_G__tag","children":"template"}],["$","span","msbuild-8",{"className":"page-module__dgei_G__tag","children":"msbuild"}],["$","span",".env-9",{"className":"page-module__dgei_G__tag","children":".env"}]]}]]}],["$","div",null,{"className":"page-module__dgei_G__heroImage","children":["$","$L4",null,{"src":"https://images.ctfassets.net/wjg1udsw901v/1IeybLQIjDnbaXTl4sbqTn/294b0ef4ad9095ee3633f6c38a0e35aa/hero.png","alt":"Adding environments to ASP.NET Core with React.js SPA","fill":true,"className":"page-module__dgei_G__heroImageImg","priority":true,"sizes":"(max-width: 800px) 100vw, 800px"}]}],"$L5","$L6","$L7"]}]],["$L8","$L9"],"$La"]}],"loading":null,"isPartial":false}
5:["$","$Lb",null,{"url":"https://www.faesel.com/blog/aspnet-core-react-spa-adding-environments","title":"Adding environments to ASP.NET Core with React.js SPA","description":"Recently I started working on a project that was created from the **ASP.NET SPA template for react**. It's one of the templates you get by default with dotnet a","variant":"sidebar"}]
c:T8b47,<p>Recently I started working on a project that was created from the <strong>ASP.NET SPA template for react</strong>. It&#39;s one of the templates you get by default with dotnet and can be created by running <code>dotnet new react</code>.</p>
<p>The template creates a dotnet webapp which is designed to be an API backend and links it with a react project to power the UI. When running the project from dotnet, static files are built from the react project and served up.</p>
<p>In terms of running the application with different environments, the dotnet perspective is fairly straight forward as we can simply use the environment variable <code>ASPNETCORE_ENVIRONMENT</code>. But the question is how do we pass this variable to the SPA so that we can shift between different environments?</p>
<p>Having trawled the internet I didn&#39;t see any examples, so I decided to create my own!</p>
<h1>Understanding the ASP.NET spa template üîç</h1>
<p>Let&#39;s begin by creating a boilerplate solution with <code>dotnet new react</code>. Once the solution is created we end up with a backend API with a <code>WeatherForecastController</code>, and a front end app located in the <code>ClientApp</code> folder.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/65iH6wUZxUc6JSNON5gWTK/a704de8ffa2dd0d4a33eef19ebf92390/folder-structure.png" alt="Dotnet SPA Folder Structure"></p>
<p>Since this is an integrated spa, from the root of the project we are able to <code>dotnet run</code> and spin up not only the dotnet project but also the react spa.</p>
<h2>Client App</h2>
<p>The client app itself is in a completely segregated app, there&#39;s nothing special added here to make it all connect up. All your standard commands to <code>npm install/build</code> are all available to you. In fact, the template has been build based on the implementation of <code>create-react-app</code>.</p>
<p>You can also start up the project from here with <code>npm run start</code> command which will spin up a development server <strong>independent of your backend code</strong>. The execution and configuration is handled for us using <code>react-scripts</code> which was designed to help set up react projects without stress, featuring things like hot module reloading, deployment builds etc ... all standard-issue so far. So you get these npm scripts setup for you,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">  &quot;scripts&quot;: {</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">    &quot;start&quot;: &quot;rimraf ./<span class="hljs-keyword">build</span> &amp;&amp; react-scripts <span class="hljs-keyword">start</span><span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    &quot;</span><span class="hljs-keyword">build</span><span class="hljs-string">&quot;: &quot;</span>react-scripts <span class="hljs-keyword">build</span><span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    &quot;</span>test<span class="hljs-string">&quot;: &quot;</span>cross-env CI=<span class="hljs-literal">true</span> react-scripts test --env=jsdom<span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    &quot;</span>eject<span class="hljs-string">&quot;: &quot;</span>react-scripts eject<span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">    &quot;</span>lint<span class="hljs-string">&quot;: &quot;</span>eslint ./src/<span class="hljs-string">&quot;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">  },</span></span></span></code></pre><h2>Startup Class</h2>
<p>The glue that connects the backend to the frontend can be found in the <code>Startup.cs</code> class. Working from top down the first code block of interest is within the <em>ConfigureServices</em> function,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">services.AddSpaStaticFiles(configuration <span class="hljs-operator">=</span>&gt;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">  configuration.RootPath <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ClientApp/build&quot;</span><span class="hljs-comment">;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">})<span class="hljs-comment">;</span></span></span></code></pre><p>This block essentially tells your dotnet app where to find the static resources (production builds) of your spa within its bin folder. So running the command <code>dotnet publish --configuration Release</code> creates a <strong>ClientApp/Build</strong> folder with a production optimised (ie npm run build) version of our SPA, the root path simply points to this.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/4tIwYVA6pYWrGctHAzMXHT/d0836b601480a1962a7693bf4cd8b653/spa-build-folder.png" alt="clientapp-build-folder"></p>
<p>The next block to notice is in the <em>Configure</em> function,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">app.UseEndpoints(<span class="hljs-function"><span class="hljs-params">endpoints</span> =&gt;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    endpoints.MapControllerRoute(</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">        name: <span class="hljs-string">&quot;default&quot;</span>,</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">        <span class="hljs-attr">pattern</span>: <span class="hljs-string">&quot;{controller}/{action=Index}/{id?}&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">});</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">app.UseSpa(<span class="hljs-function"><span class="hljs-params">spa</span> =&gt;</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    spa.Options.SourcePath = <span class="hljs-string">&quot;ClientApp&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">    <span class="hljs-keyword">if</span> (env.IsDevelopment())</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">        spa.UseReactDevelopmentServer(npmScript: <span class="hljs-string">&quot;start&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">});</span></span></code></pre><p>There are two things that are happening here, the first is that we have dotnet server side routing connected up (with app.UseEndpoints() middleware), this means that upon receiving a HTTP request server-side routing will always take priority over client-side routing. If server-side routes fall through without matching an endpoint, we use the app.UseSpa() middleware to redirect all requests to the default page (which is your index.html file triggering the spa to load).</p>
<p>The next point is that from here we can also configure the location of our client-side source code, and the command we need to use to run our react spa as a development server when debugging.</p>
<h2>MSBuild &amp; Running NPM Commands</h2>
<p>The remaining magic is all located in the .csproj file we got 2 core components here the first is the Debug target,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-tag">&lt;<span class="hljs-name">Target</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;DebugEnsureNodeEnv&quot;</span> <span class="hljs-attr">BeforeTargets</span>=<span class="hljs-string">&quot;Build&quot;</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Debug&#x27; And !Exists(&#x27;$(SpaRoot)node_modules&#x27;) &quot;</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  <span class="hljs-comment">&lt;!-- Ensure Node.js is installed --&gt;</span></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">&quot;node --version&quot;</span> <span class="hljs-attr">ContinueOnError</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    <span class="hljs-tag">&lt;<span class="hljs-name">Output</span> <span class="hljs-attr">TaskParameter</span>=<span class="hljs-string">&quot;ExitCode&quot;</span> <span class="hljs-attr">PropertyName</span>=<span class="hljs-string">&quot;ErrorCode&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">  <span class="hljs-tag">&lt;/<span class="hljs-name">Exec</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Error</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">&quot;&#x27;$(ErrorCode)&#x27; != &#x27;0&#x27;&quot;</span> <span class="hljs-attr">Text</span>=<span class="hljs-string">&quot;Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE.&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Message</span> <span class="hljs-attr">Importance</span>=<span class="hljs-string">&quot;high&quot;</span> <span class="hljs-attr">Text</span>=<span class="hljs-string">&quot;Restoring dependencies using &#x27;npm&#x27;. This may take several minutes...&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">WorkingDirectory</span>=<span class="hljs-string">&quot;$(SpaRoot)&quot;</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">&quot;npm install&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"><span class="hljs-tag">&lt;/<span class="hljs-name">Target</span>&gt;</span></span></span></code></pre><p>This chunky block of code runs an <code>npm install</code> command before building your dotnet application. It also features a nice check to ensure you got Node.js installed (I guess for the backend people üòÅ). It does this with the <code>&lt;Exec WorkingDirectory=&quot;$(SpaRoot)&quot; Command=&quot;npm install&quot; /&gt;</code> command runner (note SpaRoot is defined a the top as a static property pointing to *<em>ClientApp*</em>).</p>
<p>The second part is the publish target,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-tag">&lt;<span class="hljs-name">Target</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;PublishRunWebpack&quot;</span> <span class="hljs-attr">AfterTargets</span>=<span class="hljs-string">&quot;ComputeFilesToPublish&quot;</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  <span class="hljs-comment">&lt;!-- As part of publishing, ensure the JS resources are freshly built in production mode --&gt;</span></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">WorkingDirectory</span>=<span class="hljs-string">&quot;$(SpaRoot)&quot;</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">&quot;npm install&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">WorkingDirectory</span>=<span class="hljs-string">&quot;$(SpaRoot)&quot;</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">&quot;npm run build&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">  <span class="hljs-comment">&lt;!-- Include the newly-built files in the publish output --&gt;</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">  <span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">    <span class="hljs-tag">&lt;<span class="hljs-name">DistFiles</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">&quot;$(SpaRoot)build\**&quot;</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">    <span class="hljs-tag">&lt;<span class="hljs-name">ResolvedFileToPublish</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">&quot;@(DistFiles-&gt;&#x27;%(FullPath)&#x27;)&quot;</span> <span class="hljs-attr">Exclude</span>=<span class="hljs-string">&quot;@(ResolvedFileToPublish)&quot;</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">      <span class="hljs-tag">&lt;<span class="hljs-name">RelativePath</span>&gt;</span>%(DistFiles.Identity)<span class="hljs-tag">&lt;/<span class="hljs-name">RelativePath</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">      <span class="hljs-tag">&lt;<span class="hljs-name">CopyToPublishDirectory</span>&gt;</span>PreserveNewest<span class="hljs-tag">&lt;/<span class="hljs-name">CopyToPublishDirectory</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">      <span class="hljs-tag">&lt;<span class="hljs-name">ExcludeFromSingleFile</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">ExcludeFromSingleFile</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    <span class="hljs-tag">&lt;/<span class="hljs-name">ResolvedFileToPublish</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">  <span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content"><span class="hljs-tag">&lt;/<span class="hljs-name">Target</span>&gt;</span></span></span></code></pre><p>Again fairly similar concept running a publish first installs dependencies then builds the project. The build artefacts get created in the <strong>ClientApp\build</strong> folder. The item group block then ensures the build assets are included in your <strong>bin\ClientApp\build</strong> folder.</p>
<h2>Summary</h2>
<p>So to summarise, when running in debug mode</p>
<ol>
<li>We npm install dependencies</li>
<li>Build and run the dotnet app</li>
<li>Run an npm development server</li>
<li>Begin routing all calls to the backend, and where it fails to the default client page.</li>
</ol>
<p>In the case of a published application</p>
<ol>
<li>We create a published version of the dotnet application</li>
<li>We npm install dependencies</li>
<li>We create a production build of the spa in the folder <strong>ClientApp\build</strong></li>
<li>Static files from the spa are included in the output</li>
<li>Running the application now has a packaged version of the spa its static files are served up upon running the backend.</li>
</ol>
<p>This is all well and great so far... but the react app gets pre built.. what if we need to run it as part of a different environment? Currently, it&#39;s all running off a single <code>.env</code> file!</p>
<h1>Adding environments üÜï</h1>
<p>Below is my solution for getting environments running across the stack, it also conforms to the dev-ops ethos of,</p>
<blockquote>
<p>Build once and deploy many times.</p>
</blockquote>
<h2>Install the dependencies</h2>
<p>To being adding environments we first need to ensure our npm app can support it. For this, we will use the well know <a href="https://www.npmjs.com/package/env-cmd">env-cmd</a>. </p>
<p>We will also be needing something to manipulate the build folders generated by react-scripts. Since all operating systems are equipped with CLI commands to rename/remove files we don&#39;t need anything special to do this. However, because these commands differ from one operating system to the next, it&#39;s always a good practice to use something like <a href="https://www.npmjs.com/package/shx">shx</a> to ensure it works cross-platform.</p>
<p>So let&#39;s start with running the install command in the ClientApp folder,</p>
<p><code>npm install env-cmd shx --save-dev</code></p>
<h2>Add your environment files</h2>
<p>Next let&#39;s start creating some environment files, the file structure should look something like this, with the .env file containing settings shared across all the environments:</p>
<ul>
<li>.env</li>
<li>.env.staging</li>
<li>.env.production</li>
</ul>
<p>Any key on these files need to be prefixed with <code>REACT_APP_</code> this is a safety feature build in,</p>
<blockquote>
<p>You must create custom environment variables beginning with REACT_APP_. Any other variables except NODE_ENV will be ignored to avoid accidentally exposing a private key on the machine that could have the same name.</p>
</blockquote>
<p>For now, let&#39;s add just add an environment variable that tells us which environment we are in. Do this for both production and staging .env files.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-attr">REACT_APP_ENV</span>=<span class="hljs-string">&#x27;production&#x27;</span></span></span></code></pre><p>To show our environment on the page lets also create a <em>config.js</em> file, that accesses the environment variable.</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">export</span> <span class="hljs-type">const</span> config = {</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">    ENVIRONMENT: process.env.REACT_APP_ENV </span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">};</span></span></code></pre><p>And finally output it to the page,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Container</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reactstrap&#x27;</span>;</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NavMenu</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./NavMenu&#x27;</span>;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../config&#x27;</span>;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">  <span class="hljs-keyword">static</span> displayName = <span class="hljs-title class_">Layout</span>.<span class="hljs-property">name</span>;</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">  <span class="hljs-title function_">render</span> () {</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    <span class="hljs-keyword">return</span> (</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        {config.ENVIRONMENT}</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">        <span class="hljs-tag">&lt;<span class="hljs-name">NavMenu</span> /&gt;</span></span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">        <span class="hljs-tag">&lt;<span class="hljs-name">Container</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">          {this.props.children}</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">        <span class="hljs-tag">&lt;/<span class="hljs-name">Container</span>&gt;</span></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    );</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">  }</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content"></span></span></code></pre><h2>Add your build scripts</h2>
<p>Build scripts are now needed to trigger the environments, we need to make the following amends to the npm scripts section,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">  &quot;scripts&quot;: {</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">    &quot;<span class="hljs-keyword">build</span>:staging<span class="hljs-string">&quot;: &quot;</span>env-cmd -f .env.staging react-scripts <span class="hljs-keyword">build</span> &amp;&amp; shx rm -rf staging &amp;&amp; shx cp -r <span class="hljs-keyword">build</span> staging<span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">    &quot;</span><span class="hljs-keyword">build</span>:production<span class="hljs-string">&quot;: &quot;</span>env-cmd -f .env.production react-scripts <span class="hljs-keyword">build</span> &amp;&amp; shx rm -rf production &amp;&amp; shx cp -r <span class="hljs-keyword">build</span> production<span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">    &quot;</span><span class="hljs-keyword">start</span>:staging<span class="hljs-string">&quot;: &quot;</span>rimraf ./<span class="hljs-keyword">build</span> &amp;&amp; env-cmd -f .env.staging react-scripts <span class="hljs-keyword">start</span><span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">    &quot;</span><span class="hljs-keyword">start</span>:production<span class="hljs-string">&quot;: &quot;</span>rimraf ./<span class="hljs-keyword">build</span> &amp;&amp; env-cmd -f .env.production react-scripts <span class="hljs-keyword">start</span><span class="hljs-string">&quot;,</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">  }</span></span></span></code></pre><p>The scripts prefixed with <em>build</em> are using env-cmd with its respective environment file to create a production build of the app. The shx part is then firstly removing the folder staging/production then copying the <em>build</em> files react-script creates into an environment specific folder.</p>
<p>Similarly the scripts prefixed with <em>start</em> run the app using a certain environment. Note if your trying to run this from the dotnet app, you will need to change the Startup.cs &gt; UseReactDevelopmentServer function to,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">spa<span class="hljs-selector-class">.UseReactDevelopmentServer</span>(npmScript: <span class="hljs-string">&quot;start:production&quot;</span>);</span></span></code></pre><p>Now that this is set up, running the app should show the environment variables.</p>
<h2>Modifying your .csproj</h2>
<p>The next step is to get this working with <code>dotnet publish</code>! To do this we need to modify the <strong>PublishRunWebpack</strong> target in the .csproj file to,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">&lt;Target Name<span class="hljs-operator">=</span><span class="hljs-string">&quot;PublishRunWebpack&quot;</span> AfterTargets<span class="hljs-operator">=</span><span class="hljs-string">&quot;ComputeFilesToPublish&quot;</span>&gt;</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">  &lt;Exec WorkingDirectory<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)&quot;</span> Command<span class="hljs-operator">=</span><span class="hljs-string">&quot;npm install&quot;</span>/&gt;</span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content">  &lt;Message Importance<span class="hljs-operator">=</span><span class="hljs-string">&quot;high&quot;</span> Text<span class="hljs-operator">=</span><span class="hljs-string">&quot;Started building staging version of the spa ...&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span>/&gt;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content">  &lt;Exec WorkingDirectory<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)&quot;</span> Command<span class="hljs-operator">=</span><span class="hljs-string">&quot;npm run build:staging&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span>/&gt;</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content">  &lt;Message Importance<span class="hljs-operator">=</span><span class="hljs-string">&quot;high&quot;</span> Text<span class="hljs-operator">=</span><span class="hljs-string">&quot;Started building production version of the spa ...&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span>/&gt;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">  &lt;Exec WorkingDirectory<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)&quot;</span> Command<span class="hljs-operator">=</span><span class="hljs-string">&quot;npm run build:production&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span>/&gt;</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">  &lt;Exec WorkingDirectory<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)&quot;</span> Command<span class="hljs-operator">=</span><span class="hljs-string">&quot;npm run build&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Debug&#x27; &quot;</span> /&gt;</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">  &lt;ItemGroup&gt;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    &lt;DistFiles Include<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)build\**&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Debug&#x27; &quot;</span> /&gt;</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">    &lt;DistFiles Include<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)staging\**&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span> /&gt;</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    &lt;DistFiles Include<span class="hljs-operator">=</span><span class="hljs-string">&quot;$(SpaRoot)production\**&quot;</span> Condition<span class="hljs-operator">=</span><span class="hljs-string">&quot; &#x27;$(Configuration)&#x27; == &#x27;Release&#x27; &quot;</span> /&gt;</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    &lt;ResolvedFileToPublish Include<span class="hljs-operator">=</span><span class="hljs-string">&quot;@(DistFiles-&gt;&#x27;%(FullPath)&#x27;)&quot;</span> Exclude<span class="hljs-operator">=</span><span class="hljs-string">&quot;@(ResolvedFileToPublish)&quot;</span>&gt;</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">      &lt;RelativePath&gt;%(DistFiles.Identity)&lt;/RelativePath&gt;</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">      &lt;CopyToPublishDirectory&gt;PreserveNewest&lt;/CopyToPublishDirectory&gt;</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">      &lt;ExcludeFromSingleFile&gt;true&lt;/ExcludeFromSingleFile&gt;</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    &lt;/ResolvedFileToPublish&gt;</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">  &lt;/ItemGroup&gt;</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">&lt;/Target&gt;</span></span></code></pre><p>To summarise what&#39;s happening here, when building in debug mode we are continuing to use the <code>npm run build</code> command to create a production build and the spa files get stored in the build folder <code>$(SpaRoot)build\**</code>. The output looks like this:</p>
<ul>
<li>bin<ul>
<li>Release<ul>
<li>publish<ul>
<li>ClientApp<ul>
<li>build<br>-spa files go here!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>However in release mode we now create two versions of the spa (one for each environment) using out new npm environment builds, <code>npm run build:staging</code> and  <code>npm run build:production</code>. The builds also get moved to their corresponding folders.</p>
<ul>
<li>bin<ul>
<li>Release<ul>
<li>publish<ul>
<li>ClientApp<ul>
<li>staging<ul>
<li>staging spa files go here!</li>
</ul>
</li>
<li>production<ul>
<li>production spa files go here!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Once thats setup you can test it out with <code>dotnet publish --configuration Release</code>, the build output should look something like this,</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/6gBCaZH5bJ6vaNW2wf8QPD/7b1fcf59b5a716760ebf49c95aaaab85/BuildExample.png" alt="build-output-spa"></p>
<h2>Modifying your startup.cs</h2>
<p>The final step is to modify your Startup.cs file to switch out which spa to use based on the environment variable,</p>
<pre><code class="hljs "><span class="code-line"><span class="line-number">1</span><span class="line-content">services.AddSpaStaticFiles(<span class="hljs-function"><span class="hljs-params">configuration</span> =&gt;</span> configuration.RootPath = WebHostEnvironment.IsDevelopment()</span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content">                ? <span class="hljs-string">&quot;ClientApp/build&quot;</span></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content">                : $<span class="hljs-string">&quot;ClientApp/{WebHostEnvironment.EnvironmentName}&quot;</span>);</span></span></code></pre><h1>How to deploy üöÄ</h1>
<p>Deployment is now a simple case of running <code>dotnet publish --configuration Release</code>, once the published artefacts are deployed the app can now take its environment and run the appropriate spa. Build once and deploy anywhere!</p>
6:["$","div",null,{"className":"page-module__dgei_G__content","dangerouslySetInnerHTML":{"__html":"$c"}}]
7:["$","$Lb",null,{"url":"https://www.faesel.com/blog/aspnet-core-react-spa-adding-environments","title":"Adding environments to ASP.NET Core with React.js SPA","description":"Recently I started working on a project that was created from the **ASP.NET SPA template for react**. It's one of the templates you get by default with dotnet a"}]
8:["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/4c98436a675d5713.css","precedence":"next"}]
9:["$","script","script-0",{"src":"/_next/static/chunks/34e59d4fa8652639.js","async":true}]
a:["$","$Ld",null,{"children":["$","$e",null,{"name":"Next.MetadataOutlet","children":"$@f"}]}]
f:null
