1:"$Sreact.fragment"
2:I[22016,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],""]
3:I[5500,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],"Image"]
4:I[23150,["/_next/static/chunks/8be72f203fe36d6f.js","/_next/static/chunks/34e59d4fa8652639.js"],"default"]
a:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/708205fa81a1891d.js"],"OutletBoundary"]
b:"$Sreact.suspense"
:HL["/_next/static/chunks/4c98436a675d5713.css","style"]
5:T7abc,<p>I&#39;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Using a queue based system for this is great because it allows us to replay any queue messages, should one of the 3rd party&#39;s (or our code) fail to send the message. </p>
<p>Since we are connecting into 3rd party&#39;s you can almost guarantee there&#39;s going to be some form of failure. So its always good practice to leverage on this type of architecture to handle the unknown. We have the following setup:</p>
<ul>
<li>Website¬†&gt; Storage Queue¬†&gt; Web Job¬†&gt; Send Grid</li>
<li>Website¬†&gt; Storage Queue¬†&gt; Web Job¬†&gt; Twillio</li>
</ul>
<p>When a failure occurs, queue messages are automatically moved from the<br>message queue into a poison queue,¬†these queues¬†are always suffixed with &quot;poison&quot; (MS really wanted to highlight how toxic your problems are) like so:</p>
<ul>
<li>email - For normal operation</li>
<li>email-poison - Messages moved here when a failure occurs</li>
<li>sms</li>
<li>sms-poison</li>
</ul>
<p>Gaining visibility of what&#39;s in a poison queue is really important in knowing<br>the health of your system. So I embarked upon a task in seeking out an<br>alert setting buried deep somewhere in¬†the Azure portal to help¬†surface<br>any messages going into the poison queue. I knew this would be a metric<br>alert of some kind either in the &#39;Storage Account&#39;, &#39;Alerts&#39; or perhaps<br>even &#39;Application Insights&#39; blade. </p>
<p>After having spent a while searching for it as well as posting this Stack Overflow¬†question (it wasn&#39;t a popular one..), I started doubting whether it even existed!</p>
<p>I even tried the search box at the top of the azure dashboard as a last ditch effort, hoping it will provide answers. You think this would<br>exists somewhere (if it does and my eyes have deceived me please do get<br>in touch) or at the very least be visible and easily findable? Alas this was not the case..</p>
<p>So I decided to do something about it, </p>
<blockquote>
<p>why not have an Azure function that takes a storage account and looks through all the queues to check if any poison queue messages exist. </p>
</blockquote>
<p>Whilst were at it we could also check if messages are stacking up in the non-poison queues (just in-case a Webjob has been turned off or cant process a certain message), and even provide the content of a problematic queue message. Since our team uses slack for communication I decided to send the notification to Slack. Below are the steps I took:</p>
<p>#Step 1 - Setting up slack</p>
<p>Setting up slack is quick and easy, just create a &#39;poison-queue&#39; channel, and create a new integration in the custom integrations section (Note your gonna have to get admin access to do this (I have provided a link at the bottom of this article as its nested deep in their UI). An integration is essentially a web hook endpoint for us to post JSON data to (I have added a link for Slacks JSON format below too, as well as a message builder to help customise the look and feel).</p>
<p>The picture below show where you can get your web hook URL from.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/1y3YcZQRnN6yhsilboTyhL/5c9fad66a9601cc851c9377d26198258/slackwebhook.jpg" alt="Azure Queue Notifier - Slack Integration"></p>
<p>#Step 2 - Create your Azure Function</p>
<p>Since this is not a tutorial on Azure Functions, I&#39;m going to skip going into detail here. Microsoft however have provided some great documentation on this (with pictures!) to help you out. Links are at the end until MS break them. By the way your gonna need a cron expression to define the timeframe for this function to work in, if you hate cron as much as I do worry not! Use my cron expression for a daily sobering alert at 9:00 - 0 0 9 * * *</p>
<p>#Step 3 - Create your slack message structure</p>
<p>Next we can create the basic structure needed for our Slack message, expressed as a C# class. My class is actually quite simple and missing quite a few properties, to get a sense of all the customisations Slack offers have a look at the links below.</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SlackMessage</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SlackMessage</span>()</span></span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        Attachments = <span class="hljs-keyword">new</span> List&lt;Attachments&gt;();</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;channel&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Channel { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;username&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> UserName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;text&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;attachments&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">    <span class="hljs-keyword">public</span> List&lt;Attachments&gt; Attachments { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;icon_emoji&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Icon</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content">        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;:computer:&quot;</span>; }</span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">32</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">33</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">34</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">35</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">36</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">37</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">38</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Attachments</span></span></span>
<span class="code-line"><span class="line-number">39</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">40</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;color&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">41</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Colour { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">42</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">43</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;title&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">44</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">45</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">46</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;text&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">47</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">48</span><span class="line-content">}</span></span></code></pre><p>Remember to create these classes as .csx files for the Azure function to understand them.</p>
<p>#Step 4 - Create a slack client to post the message</p>
<p>Now that we have our message structure we can create a class to serialize and post the JSON to Slack using the Webhook created in <strong>Step 1</strong>, below is the code to do this,</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"><span class="hljs-meta">#r &quot;System.Web.Extensions&quot;</span></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#r &quot;System.Web&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackMessage.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">using</span> System.Net;</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Specialized;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SlackClient</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> WebHook = <span class="hljs-string">@&quot;https://hooks.slack.com/services/XXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params">SlackMessage message</span>)</span></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">        <span class="hljs-built_in">string</span> payloadJson = JsonConvert.SerializeObject(message);</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        </span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        <span class="hljs-keyword">using</span> (WebClient client = <span class="hljs-keyword">new</span> WebClient())</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">            NameValueCollection data = <span class="hljs-keyword">new</span> NameValueCollection();</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">            data[<span class="hljs-string">&quot;payload&quot;</span>] = payloadJson;</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">            client.UploadValues(WebHook, <span class="hljs-string">&quot;POST&quot;</span>, data);</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">}</span></span></code></pre><p>Its good practice to move the Webhook URL into the settings file, for simplicity I have included it into this class.</p>
<p>#Step 5 - Queue Checker</p>
<p>Next we need to add code to loop through any connections string we pass it, check all the queues and send messages if we think there&#39;s something wrong.</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Microsoft.WindowsAzure.Storage&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackClient.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackMessage.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">using</span> System.Linq;</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"><span class="hljs-keyword">using</span> Microsoft.WindowsAzure.Storage;</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content"><span class="hljs-keyword">using</span> Microsoft.WindowsAzure.Storage.Auth;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PoisonQueueChecker</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckPoisonQueues</span>(<span class="hljs-params">Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; storageConnectionStrings</span>)</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">        <span class="hljs-keyword">var</span> slackClient = <span class="hljs-keyword">new</span> SlackClient();</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">        <span class="hljs-keyword">var</span> slackMessage = <span class="hljs-keyword">new</span> SlackMessage { Text = <span class="hljs-string">&quot;Poison Queue Alerts&quot;</span>, Channel = <span class="hljs-string">&quot;poison-queue&quot;</span> };</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> storageConnectionString <span class="hljs-keyword">in</span> storageConnectionStrings)</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">            <span class="hljs-keyword">var</span> storageCredentials = <span class="hljs-keyword">new</span> StorageCredentials(storageConnectionString.Key, storageConnectionString.Value);</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">            <span class="hljs-keyword">var</span> storageAccount = <span class="hljs-keyword">new</span> CloudStorageAccount(storageCredentials, <span class="hljs-literal">true</span>);</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">            <span class="hljs-keyword">var</span> queueClient = storageAccount.CreateCloudQueueClient();</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">            <span class="hljs-keyword">var</span> queues = queueClient.ListQueues();</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> queue <span class="hljs-keyword">in</span> queues)</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">            {</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">                queue.FetchAttributes();</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content">                <span class="hljs-comment">//Gets the total messages in the queue</span></span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content">                <span class="hljs-keyword">var</span> queueCount = queue.ApproximateMessageCount;</span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">32</span><span class="line-content">                <span class="hljs-keyword">if</span> (queueCount &gt; <span class="hljs-number">0</span>)</span></span>
<span class="code-line"><span class="line-number">33</span><span class="line-content">                {</span></span>
<span class="code-line"><span class="line-number">34</span><span class="line-content">                    <span class="hljs-keyword">var</span> isPoisonQueue = queue.Name.EndsWith(<span class="hljs-string">&quot;poison&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">35</span><span class="line-content">                    <span class="hljs-keyword">var</span> attachment = <span class="hljs-keyword">new</span> Attachments();</span></span>
<span class="code-line"><span class="line-number">36</span><span class="line-content">                    attachment.Title = <span class="hljs-string">$&quot;Queue: <span class="hljs-subst">{queue.Name}</span>, Message Count: <span class="hljs-subst">{queueCount}</span>&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">37</span><span class="line-content">                    attachment.Colour = isPoisonQueue ? <span class="hljs-string">&quot;danger&quot;</span> : <span class="hljs-string">&quot;warning&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">38</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">39</span><span class="line-content">                    <span class="hljs-comment">//Note the peek function will not dequeue the message</span></span></span>
<span class="code-line"><span class="line-number">40</span><span class="line-content">                    <span class="hljs-keyword">var</span> message = queue.PeekMessage();</span></span>
<span class="code-line"><span class="line-number">41</span><span class="line-content">                    attachment.Text = <span class="hljs-string">$@&quot;Insertion Time: <span class="hljs-subst">{message.InsertionTime}</span>, Sample Contents:\n&quot;</span> +</span></span>
<span class="code-line"><span class="line-number">42</span><span class="line-content">                                        <span class="hljs-string">$&quot; <span class="hljs-subst">{message.AsString}</span>&quot;</span>;                        </span></span>
<span class="code-line"><span class="line-number">43</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">44</span><span class="line-content">                    slackMessage.Attachments.Add(attachment);</span></span>
<span class="code-line"><span class="line-number">45</span><span class="line-content">                }</span></span>
<span class="code-line"><span class="line-number">46</span><span class="line-content">            }</span></span>
<span class="code-line"><span class="line-number">47</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">48</span><span class="line-content">            <span class="hljs-comment">//Add a message showing all is well</span></span></span>
<span class="code-line"><span class="line-number">49</span><span class="line-content">            <span class="hljs-keyword">if</span> (!slackMessage.Attachments.Any())</span></span>
<span class="code-line"><span class="line-number">50</span><span class="line-content">            {</span></span>
<span class="code-line"><span class="line-number">51</span><span class="line-content">                slackMessage.Attachments.Add(<span class="hljs-keyword">new</span> Attachments { Title = <span class="hljs-string">&quot;All queues are operational and empty&quot;</span>, Colour = <span class="hljs-string">&quot;good&quot;</span> });</span></span>
<span class="code-line"><span class="line-number">52</span><span class="line-content">            }</span></span>
<span class="code-line"><span class="line-number">53</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">54</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">55</span><span class="line-content">        slackClient.SendMessage(slackMessage);</span></span>
<span class="code-line"><span class="line-number">56</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">57</span><span class="line-content">}</span></span></code></pre><p>#Step 6 - Being it all together</p>
<p>Final step is to hook up the functions run method like so:</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#load &quot;PoisonQueueChecker.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-keyword">using</span> System;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params">TimerInfo myTimer, TraceWriter log</span>)</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">    log.Info(<span class="hljs-string">$&quot;C# Timer trigger function executed at: <span class="hljs-subst">{DateTime.Now}</span>&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    <span class="hljs-keyword">var</span> storageConnectionStrings = <span class="hljs-keyword">new</span> Dictionary();</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    storageConnectionStrings.Add(<span class="hljs-string">&quot;storagename&quot;</span>, <span class="hljs-string">&quot;storagekey&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    <span class="hljs-keyword">var</span> poisonQueueChecker = <span class="hljs-keyword">new</span> PoisonQueueChecker();</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    poisonQueueChecker.CheckPoisonQueues(storageConnectionStrings);</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">}</span></span></code></pre><p>And that&#39;s it, 9 O&#39;clock tomorrow you can finally start gaining visibility of those poison queues and start worrying about those dodgy lines of code causing your messages to be poisoned.</p>
<p>#Helpful Links</p>
<p>Custom Integrations</p>
<p>https://&lt;<yourslackgroupname>&gt;.slack.com/apps/manage/custom-integrations</p>
<p>Customising your slack message</p>
<p><a href="https://api.slack.com/docs/messages/builder">https://api.slack.com/docs/messages/builder</a></p>
<p>How to send a slack message to your web hook:</p>
<p><a href="https://api.slack.com/custom-integrations/incoming-webhooks">https://api.slack.com/custom-integrations/incoming-webhooks</a></p>
<p>How to create a azure function:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function">https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function</a></p>
<p>How to code up a azure function:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp">https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp</a></p>
0:{"buildId":"8lhBC1nouQpaYNAX92Zt7","rsc":["$","$1","c",{"children":[[["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BlogPosting\",\"headline\":\"Making a Azure poison queue Slack notifier\",\"description\":\"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us\",\"image\":\"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg\",\"datePublished\":\"2017-09-23T00:00+01:00\",\"dateModified\":\"2017-09-23T00:00+01:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Faesel Saeed\",\"url\":\"https://www.faesel.com/about\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Faesel Saeed\",\"url\":\"https://www.faesel.com\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https://www.faesel.com/images/logo.png\"}},\"keywords\":\"azure, poison queue, monitoring, slack, azure-queues\",\"url\":\"https://www.faesel.com/blog/azure-poison-queue-notifier\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https://www.faesel.com/blog/azure-poison-queue-notifier\"}}"}}],["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BreadcrumbList\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https://www.faesel.com\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Blog\",\"item\":\"https://www.faesel.com/blog\"},{\"@type\":\"ListItem\",\"position\":3,\"name\":\"Making a Azure poison queue Slack notifier\",\"item\":\"https://www.faesel.com/blog/azure-poison-queue-notifier\"}]}"}}],["$","article",null,{"className":"page-module__dgei_G__article","children":[["$","$L2",null,{"href":"/blog","className":"page-module__dgei_G__backLink","children":"‚Üê Back to Blog"}],["$","header",null,{"className":"page-module__dgei_G__header","children":[["$","h1",null,{"className":"page-module__dgei_G__title","children":"Making a Azure poison queue Slack notifier"}],["$","div",null,{"className":"page-module__dgei_G__meta","children":[["$","time",null,{"className":"page-module__dgei_G__date","dateTime":"2017-09-23T00:00+01:00","children":["üìÖ ","September 22, 2017"]}],["$","span",null,{"className":"page-module__dgei_G__separator","children":"‚Ä¢"}],["$","span",null,{"className":"page-module__dgei_G__readingTime","children":["‚è±Ô∏è ","6 min read"]}]]}],["$","div",null,{"className":"page-module__dgei_G__tags","children":[["$","span","azure-0",{"className":"page-module__dgei_G__tag","children":"azure"}],["$","span","poison queue-1",{"className":"page-module__dgei_G__tag","children":"poison queue"}],["$","span","monitoring-2",{"className":"page-module__dgei_G__tag","children":"monitoring"}],["$","span","slack-3",{"className":"page-module__dgei_G__tag","children":"slack"}],["$","span","azure-queues-4",{"className":"page-module__dgei_G__tag","children":"azure-queues"}]]}]]}],["$","div",null,{"className":"page-module__dgei_G__heroImage","children":["$","$L3",null,{"src":"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg","alt":"Making a Azure poison queue Slack notifier","fill":true,"className":"page-module__dgei_G__heroImageImg","priority":true,"sizes":"(max-width: 800px) 100vw, 800px"}]}],["$","$L4",null,{"url":"https://www.faesel.com/blog/azure-poison-queue-notifier","title":"Making a Azure poison queue Slack notifier","description":"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us","variant":"sidebar"}],["$","div",null,{"className":"page-module__dgei_G__content","dangerouslySetInnerHTML":{"__html":"$5"}}],"$L6"]}]],["$L7","$L8"],"$L9"]}],"loading":null,"isPartial":false}
6:["$","$L4",null,{"url":"https://www.faesel.com/blog/azure-poison-queue-notifier","title":"Making a Azure poison queue Slack notifier","description":"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us"}]
7:["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/4c98436a675d5713.css","precedence":"next"}]
8:["$","script","script-0",{"src":"/_next/static/chunks/34e59d4fa8652639.js","async":true}]
9:["$","$La",null,{"children":["$","$b",null,{"name":"Next.MetadataOutlet","children":"$@c"}]}]
c:null
