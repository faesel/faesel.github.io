<!DOCTYPE html><!--UQsEyOaKqlix4m0ZQW2sG--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/images/logo-small.png"/><link rel="preload" as="image" href="https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg"/><link rel="stylesheet" href="/_next/static/chunks/19d110f125a6a880.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/chunks/bc2ec6988ea822be.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/ba947f6798c3c403.js"/><script src="/_next/static/chunks/9a513a8c4dabec14.js" async=""></script><script src="/_next/static/chunks/713fc8ad9ceac69a.js" async=""></script><script src="/_next/static/chunks/19e94e7551cef099.js" async=""></script><script src="/_next/static/chunks/turbopack-2ca5897f65736e1e.js" async=""></script><script src="/_next/static/chunks/8be72f203fe36d6f.js" async=""></script><script src="/_next/static/chunks/ff1a16fafef87110.js" async=""></script><script src="/_next/static/chunks/708205fa81a1891d.js" async=""></script><link rel="preload" href="/_next/static/chunks/578ca6ed020117e9.css" as="style"/><link rel="preload" href="https://www.googletagmanager.com/gtag/js?id=test" as="script"/><title>Making a Azure poison queue Slack notifier | Tech Blog | FAESEL.COM</title><meta name="description" content="I&#x27;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us"/><link rel="author" href="https://www.faesel.com/about"/><meta name="author" content="Faesel Saeed"/><meta name="keywords" content="azure,poison queue,monitoring,slack,azure-queues"/><meta property="og:title" content="Making a Azure poison queue Slack notifier"/><meta property="og:description" content="I&#x27;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us"/><meta property="og:image" content="https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2017-09-23T00:00+01:00"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@faeselsaeed"/><meta name="twitter:creator" content="@faeselsaeed"/><meta name="twitter:title" content="Making a Azure poison queue Slack notifier"/><meta name="twitter:description" content="I&#x27;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us"/><meta name="twitter:image" content="https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/favicon.ico"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"Faesel Saeed","url":"https://www.faesel.com","logo":{"@type":"ImageObject","url":"https://www.faesel.com/images/logo.png"},"sameAs":["https://github.com/faeselsaeed","https://www.linkedin.com/in/faesel-saeed-a97b1614"]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"FAESEL.COM","url":"https://www.faesel.com","description":"A modern tech blog exploring technology, coding, and digital innovation","publisher":{"@type":"Organization","name":"Faesel Saeed","url":"https://www.faesel.com"}}</script><script src="/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body><div hidden=""><!--$--><!--/$--></div><a href="#main-content" class="skip-to-content">Skip to content</a><header class="Header-module__hBw1pG__header"><div class="Header-module__hBw1pG__container"><a class="Header-module__hBw1pG__logo" aria-label="Home" href="/"><img alt="Logo" width="40" height="40" decoding="async" data-nimg="1" class="Header-module__hBw1pG__logoImage" style="color:transparent" src="/images/logo-small.png"/></a><button class="Header-module__hBw1pG__mobileMenuButton" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button><nav class="Header-module__hBw1pG__nav " role="navigation" aria-label="Main navigation"><a class="Header-module__hBw1pG__navLink " href="/">Home</a><a class="Header-module__hBw1pG__navLink " href="/blog">Blog</a><a class="Header-module__hBw1pG__navLink " href="/projects">Projects</a><a class="Header-module__hBw1pG__navLink " href="/about">About</a><a class="Header-module__hBw1pG__navLink " href="/contact">Contact</a></nav></div></header><main id="main-content" style="min-height:70vh"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Making a Azure poison queue Slack notifier","description":"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us","image":"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg","datePublished":"2017-09-23T00:00+01:00","dateModified":"2017-09-23T00:00+01:00","author":{"@type":"Person","name":"Faesel Saeed","url":"https://www.faesel.com/about"},"publisher":{"@type":"Organization","name":"Faesel Saeed","url":"https://www.faesel.com","logo":{"@type":"ImageObject","url":"https://www.faesel.com/images/logo.png"}},"keywords":"azure, poison queue, monitoring, slack, azure-queues","url":"https://www.faesel.com/blog/azure-poison-queue-notifier","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.faesel.com/blog/azure-poison-queue-notifier"}}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://www.faesel.com"},{"@type":"ListItem","position":2,"name":"Blog","item":"https://www.faesel.com/blog"},{"@type":"ListItem","position":3,"name":"Making a Azure poison queue Slack notifier","item":"https://www.faesel.com/blog/azure-poison-queue-notifier"}]}</script><article class="page-module__dgei_G__article"><a class="page-module__dgei_G__backLink" href="/blog">‚Üê Back to Blog</a><header class="page-module__dgei_G__header"><h1 class="page-module__dgei_G__title">Making a Azure poison queue Slack notifier</h1><div class="page-module__dgei_G__meta"><time class="page-module__dgei_G__date" dateTime="2017-09-23T00:00+01:00">üìÖ <!-- -->September 22, 2017</time></div><div class="page-module__dgei_G__tags"><span class="page-module__dgei_G__tag">azure</span><span class="page-module__dgei_G__tag">poison queue</span><span class="page-module__dgei_G__tag">monitoring</span><span class="page-module__dgei_G__tag">slack</span><span class="page-module__dgei_G__tag">azure-queues</span></div></header><div class="page-module__dgei_G__heroImage"><img alt="Making a Azure poison queue Slack notifier" decoding="async" data-nimg="fill" class="page-module__dgei_G__heroImageImg" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" src="https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg"/></div><div class="page-module__dgei_G__content"><p>I&#39;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Using a queue based system for this is great because it allows us to replay any queue messages, should one of the 3rd party&#39;s (or our code) fail to send the message. </p>
<p>Since we are connecting into 3rd party&#39;s you can almost guarantee there&#39;s going to be some form of failure. So its always good practice to leverage on this type of architecture to handle the unknown. We have the following setup:</p>
<ul>
<li>Website¬†&gt; Storage Queue¬†&gt; Web Job¬†&gt; Send Grid</li>
<li>Website¬†&gt; Storage Queue¬†&gt; Web Job¬†&gt; Twillio</li>
</ul>
<p>When a failure occurs, queue messages are automatically moved from the<br>message queue into a poison queue,¬†these queues¬†are always suffixed with &quot;poison&quot; (MS really wanted to highlight how toxic your problems are) like so:</p>
<ul>
<li>email - For normal operation</li>
<li>email-poison - Messages moved here when a failure occurs</li>
<li>sms</li>
<li>sms-poison</li>
</ul>
<p>Gaining visibility of what&#39;s in a poison queue is really important in knowing<br>the health of your system. So I embarked upon a task in seeking out an<br>alert setting buried deep somewhere in¬†the Azure portal to help¬†surface<br>any messages going into the poison queue. I knew this would be a metric<br>alert of some kind either in the &#39;Storage Account&#39;, &#39;Alerts&#39; or perhaps<br>even &#39;Application Insights&#39; blade. </p>
<p>After having spent a while searching for it as well as posting this Stack Overflow¬†question (it wasn&#39;t a popular one..), I started doubting whether it even existed!</p>
<p>I even tried the search box at the top of the azure dashboard as a last ditch effort, hoping it will provide answers. You think this would<br>exists somewhere (if it does and my eyes have deceived me please do get<br>in touch) or at the very least be visible and easily findable? Alas this was not the case..</p>
<p>So I decided to do something about it, </p>
<blockquote>
<p>why not have an Azure function that takes a storage account and looks through all the queues to check if any poison queue messages exist. </p>
</blockquote>
<p>Whilst were at it we could also check if messages are stacking up in the non-poison queues (just in-case a Webjob has been turned off or cant process a certain message), and even provide the content of a problematic queue message. Since our team uses slack for communication I decided to send the notification to Slack. Below are the steps I took:</p>
<p>#Step 1 - Setting up slack</p>
<p>Setting up slack is quick and easy, just create a &#39;poison-queue&#39; channel, and create a new integration in the custom integrations section (Note your gonna have to get admin access to do this (I have provided a link at the bottom of this article as its nested deep in their UI). An integration is essentially a web hook endpoint for us to post JSON data to (I have added a link for Slacks JSON format below too, as well as a message builder to help customise the look and feel).</p>
<p>The picture below show where you can get your web hook URL from.</p>
<p><img src="//images.ctfassets.net/wjg1udsw901v/1y3YcZQRnN6yhsilboTyhL/5c9fad66a9601cc851c9377d26198258/slackwebhook.jpg" alt="Azure Queue Notifier - Slack Integration"></p>
<p>#Step 2 - Create your Azure Function</p>
<p>Since this is not a tutorial on Azure Functions, I&#39;m going to skip going into detail here. Microsoft however have provided some great documentation on this (with pictures!) to help you out. Links are at the end until MS break them. By the way your gonna need a cron expression to define the timeframe for this function to work in, if you hate cron as much as I do worry not! Use my cron expression for a daily sobering alert at 9:00 - 0 0 9 * * *</p>
<p>#Step 3 - Create your slack message structure</p>
<p>Next we can create the basic structure needed for our Slack message, expressed as a C# class. My class is actually quite simple and missing quite a few properties, to get a sense of all the customisations Slack offers have a look at the links below.</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SlackMessage</span></span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SlackMessage</span>()</span></span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content">        Attachments = <span class="hljs-keyword">new</span> List&lt;Attachments&gt;();</span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;channel&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Channel { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;username&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> UserName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;text&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;attachments&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">    <span class="hljs-keyword">public</span> List&lt;Attachments&gt; Attachments { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;icon_emoji&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Icon</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content">        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;:computer:&quot;</span>; }</span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">32</span><span class="line-content">}</span></span>
<span class="code-line"><span class="line-number">33</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">34</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">35</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">36</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">37</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">38</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Attachments</span></span></span>
<span class="code-line"><span class="line-number">39</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">40</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;color&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">41</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Colour { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">42</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">43</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;title&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">44</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">45</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">46</span><span class="line-content">    [<span class="hljs-meta">JsonProperty(<span class="hljs-string">&quot;text&quot;</span>)</span>]</span></span>
<span class="code-line"><span class="line-number">47</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }</span></span>
<span class="code-line"><span class="line-number">48</span><span class="line-content">}</span></span></code></pre><p>Remember to create these classes as .csx files for the Azure function to understand them.</p>
<p>#Step 4 - Create a slack client to post the message</p>
<p>Now that we have our message structure we can create a class to serialize and post the JSON to Slack using the Webhook created in <strong>Step 1</strong>, below is the code to do this,</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Newtonsoft.Json&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"><span class="hljs-meta">#r &quot;System.Web.Extensions&quot;</span></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#r &quot;System.Web&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackMessage.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">using</span> System.Net;</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"><span class="hljs-keyword">using</span> Newtonsoft.Json;</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Specialized;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SlackClient</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> WebHook = <span class="hljs-string">@&quot;https://hooks.slack.com/services/XXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params">SlackMessage message</span>)</span></span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content">        <span class="hljs-built_in">string</span> payloadJson = JsonConvert.SerializeObject(message);</span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        </span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        <span class="hljs-keyword">using</span> (WebClient client = <span class="hljs-keyword">new</span> WebClient())</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">            NameValueCollection data = <span class="hljs-keyword">new</span> NameValueCollection();</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">            data[<span class="hljs-string">&quot;payload&quot;</span>] = payloadJson;</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content">            client.UploadValues(WebHook, <span class="hljs-string">&quot;POST&quot;</span>, data);</span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">}</span></span></code></pre><p>Its good practice to move the Webhook URL into the settings file, for simplicity I have included it into this class.</p>
<p>#Step 5 - Queue Checker</p>
<p>Next we need to add code to loop through any connections string we pass it, check all the queues and send messages if we think there&#39;s something wrong.</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#r &quot;Microsoft.WindowsAzure.Storage&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackClient.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-meta">#load &quot;SlackMessage.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"><span class="hljs-meta">#load &quot;Attachments.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content"><span class="hljs-keyword">using</span> System.Linq;</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"><span class="hljs-keyword">using</span> Microsoft.WindowsAzure.Storage;</span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content"><span class="hljs-keyword">using</span> Microsoft.WindowsAzure.Storage.Auth;</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PoisonQueueChecker</span></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckPoisonQueues</span>(<span class="hljs-params">Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; storageConnectionStrings</span>)</span></span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">    {</span></span>
<span class="code-line"><span class="line-number">16</span><span class="line-content">        <span class="hljs-keyword">var</span> slackClient = <span class="hljs-keyword">new</span> SlackClient();</span></span>
<span class="code-line"><span class="line-number">17</span><span class="line-content">        <span class="hljs-keyword">var</span> slackMessage = <span class="hljs-keyword">new</span> SlackMessage { Text = <span class="hljs-string">&quot;Poison Queue Alerts&quot;</span>, Channel = <span class="hljs-string">&quot;poison-queue&quot;</span> };</span></span>
<span class="code-line"><span class="line-number">18</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">19</span><span class="line-content">        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> storageConnectionString <span class="hljs-keyword">in</span> storageConnectionStrings)</span></span>
<span class="code-line"><span class="line-number">20</span><span class="line-content">        {</span></span>
<span class="code-line"><span class="line-number">21</span><span class="line-content">            <span class="hljs-keyword">var</span> storageCredentials = <span class="hljs-keyword">new</span> StorageCredentials(storageConnectionString.Key, storageConnectionString.Value);</span></span>
<span class="code-line"><span class="line-number">22</span><span class="line-content">            <span class="hljs-keyword">var</span> storageAccount = <span class="hljs-keyword">new</span> CloudStorageAccount(storageCredentials, <span class="hljs-literal">true</span>);</span></span>
<span class="code-line"><span class="line-number">23</span><span class="line-content">            <span class="hljs-keyword">var</span> queueClient = storageAccount.CreateCloudQueueClient();</span></span>
<span class="code-line"><span class="line-number">24</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">25</span><span class="line-content">            <span class="hljs-keyword">var</span> queues = queueClient.ListQueues();</span></span>
<span class="code-line"><span class="line-number">26</span><span class="line-content">            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> queue <span class="hljs-keyword">in</span> queues)</span></span>
<span class="code-line"><span class="line-number">27</span><span class="line-content">            {</span></span>
<span class="code-line"><span class="line-number">28</span><span class="line-content">                queue.FetchAttributes();</span></span>
<span class="code-line"><span class="line-number">29</span><span class="line-content">                <span class="hljs-comment">//Gets the total messages in the queue</span></span></span>
<span class="code-line"><span class="line-number">30</span><span class="line-content">                <span class="hljs-keyword">var</span> queueCount = queue.ApproximateMessageCount;</span></span>
<span class="code-line"><span class="line-number">31</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">32</span><span class="line-content">                <span class="hljs-keyword">if</span> (queueCount &gt; <span class="hljs-number">0</span>)</span></span>
<span class="code-line"><span class="line-number">33</span><span class="line-content">                {</span></span>
<span class="code-line"><span class="line-number">34</span><span class="line-content">                    <span class="hljs-keyword">var</span> isPoisonQueue = queue.Name.EndsWith(<span class="hljs-string">&quot;poison&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">35</span><span class="line-content">                    <span class="hljs-keyword">var</span> attachment = <span class="hljs-keyword">new</span> Attachments();</span></span>
<span class="code-line"><span class="line-number">36</span><span class="line-content">                    attachment.Title = <span class="hljs-string">$&quot;Queue: <span class="hljs-subst">{queue.Name}</span>, Message Count: <span class="hljs-subst">{queueCount}</span>&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">37</span><span class="line-content">                    attachment.Colour = isPoisonQueue ? <span class="hljs-string">&quot;danger&quot;</span> : <span class="hljs-string">&quot;warning&quot;</span>;</span></span>
<span class="code-line"><span class="line-number">38</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">39</span><span class="line-content">                    <span class="hljs-comment">//Note the peek function will not dequeue the message</span></span></span>
<span class="code-line"><span class="line-number">40</span><span class="line-content">                    <span class="hljs-keyword">var</span> message = queue.PeekMessage();</span></span>
<span class="code-line"><span class="line-number">41</span><span class="line-content">                    attachment.Text = <span class="hljs-string">$@&quot;Insertion Time: <span class="hljs-subst">{message.InsertionTime}</span>, Sample Contents:\n&quot;</span> +</span></span>
<span class="code-line"><span class="line-number">42</span><span class="line-content">                                        <span class="hljs-string">$&quot; <span class="hljs-subst">{message.AsString}</span>&quot;</span>;                        </span></span>
<span class="code-line"><span class="line-number">43</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">44</span><span class="line-content">                    slackMessage.Attachments.Add(attachment);</span></span>
<span class="code-line"><span class="line-number">45</span><span class="line-content">                }</span></span>
<span class="code-line"><span class="line-number">46</span><span class="line-content">            }</span></span>
<span class="code-line"><span class="line-number">47</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">48</span><span class="line-content">            <span class="hljs-comment">//Add a message showing all is well</span></span></span>
<span class="code-line"><span class="line-number">49</span><span class="line-content">            <span class="hljs-keyword">if</span> (!slackMessage.Attachments.Any())</span></span>
<span class="code-line"><span class="line-number">50</span><span class="line-content">            {</span></span>
<span class="code-line"><span class="line-number">51</span><span class="line-content">                slackMessage.Attachments.Add(<span class="hljs-keyword">new</span> Attachments { Title = <span class="hljs-string">&quot;All queues are operational and empty&quot;</span>, Colour = <span class="hljs-string">&quot;good&quot;</span> });</span></span>
<span class="code-line"><span class="line-number">52</span><span class="line-content">            }</span></span>
<span class="code-line"><span class="line-number">53</span><span class="line-content">        }</span></span>
<span class="code-line"><span class="line-number">54</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">55</span><span class="line-content">        slackClient.SendMessage(slackMessage);</span></span>
<span class="code-line"><span class="line-number">56</span><span class="line-content">    }</span></span>
<span class="code-line"><span class="line-number">57</span><span class="line-content">}</span></span></code></pre><p>#Step 6 - Being it all together</p>
<p>Final step is to hook up the functions run method like so:</p>
<pre><code class="hljs language-csharp"><span class="code-line"><span class="line-number">1</span><span class="line-content"><span class="hljs-meta">#load &quot;PoisonQueueChecker.csx&quot;</span></span></span>
<span class="code-line"><span class="line-number">2</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">3</span><span class="line-content"><span class="hljs-keyword">using</span> System;</span></span>
<span class="code-line"><span class="line-number">4</span><span class="line-content"><span class="hljs-keyword">using</span> System.Collections.Generic;</span></span>
<span class="code-line"><span class="line-number">5</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">6</span><span class="line-content"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params">TimerInfo myTimer, TraceWriter log</span>)</span></span></span>
<span class="code-line"><span class="line-number">7</span><span class="line-content">{</span></span>
<span class="code-line"><span class="line-number">8</span><span class="line-content">    log.Info(<span class="hljs-string">$&quot;C# Timer trigger function executed at: <span class="hljs-subst">{DateTime.Now}</span>&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">9</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">10</span><span class="line-content">    <span class="hljs-keyword">var</span> storageConnectionStrings = <span class="hljs-keyword">new</span> Dictionary();</span></span>
<span class="code-line"><span class="line-number">11</span><span class="line-content">    storageConnectionStrings.Add(<span class="hljs-string">&quot;storagename&quot;</span>, <span class="hljs-string">&quot;storagekey&quot;</span>);</span></span>
<span class="code-line"><span class="line-number">12</span><span class="line-content"></span></span>
<span class="code-line"><span class="line-number">13</span><span class="line-content">    <span class="hljs-keyword">var</span> poisonQueueChecker = <span class="hljs-keyword">new</span> PoisonQueueChecker();</span></span>
<span class="code-line"><span class="line-number">14</span><span class="line-content">    poisonQueueChecker.CheckPoisonQueues(storageConnectionStrings);</span></span>
<span class="code-line"><span class="line-number">15</span><span class="line-content">}</span></span></code></pre><p>And that&#39;s it, 9 O&#39;clock tomorrow you can finally start gaining visibility of those poison queues and start worrying about those dodgy lines of code causing your messages to be poisoned.</p>
<p>#Helpful Links</p>
<p>Custom Integrations</p>
<p>https://&lt;<yourslackgroupname>&gt;.slack.com/apps/manage/custom-integrations</p>
<p>Customising your slack message</p>
<p><a href="https://api.slack.com/docs/messages/builder">https://api.slack.com/docs/messages/builder</a></p>
<p>How to send a slack message to your web hook:</p>
<p><a href="https://api.slack.com/custom-integrations/incoming-webhooks">https://api.slack.com/custom-integrations/incoming-webhooks</a></p>
<p>How to create a azure function:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function">https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function</a></p>
<p>How to code up a azure function:</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp">https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp</a></p>
</div></article><!--$--><!--/$--></main><footer class="Footer-module__S6Hkya__footer"><div class="Footer-module__S6Hkya__container"><div class="Footer-module__S6Hkya__content"><nav class="Footer-module__S6Hkya__links" aria-label="Footer navigation"><a class="Footer-module__S6Hkya__link" href="/blog">Blog</a><a class="Footer-module__S6Hkya__link" href="/projects">Projects</a><a class="Footer-module__S6Hkya__link" href="/about">About</a><a class="Footer-module__S6Hkya__link" href="/contact">Contact</a></nav><p class="Footer-module__S6Hkya__copyright">¬© <!-- -->2026<!-- --> All rights reserved.</p></div></div></footer><script src="/_next/static/chunks/ba947f6798c3c403.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[31362,[\"/_next/static/chunks/8be72f203fe36d6f.js\"],\"default\"]\n3:I[2971,[\"/_next/static/chunks/8be72f203fe36d6f.js\"],\"default\"]\n4:I[39756,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"default\"]\n5:I[37457,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"default\"]\n6:I[22016,[\"/_next/static/chunks/8be72f203fe36d6f.js\"],\"\"]\n8:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"OutletBoundary\"]\n9:\"$Sreact.suspense\"\nb:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"ViewportBoundary\"]\nd:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"MetadataBoundary\"]\nf:I[68027,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"default\"]\n:HL[\"/_next/static/chunks/19d110f125a6a880.css\",\"style\"]\n:HL[\"/_next/static/chunks/bc2ec6988ea822be.css\",\"style\"]\n:HL[\"/_next/static/chunks/578ca6ed020117e9.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"UQsEyOaKqlix4m0ZQW2sG\",\"c\":[\"\",\"blog\",\"azure-poison-queue-notifier\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"azure-poison-queue-notifier\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/19d110f125a6a880.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/8be72f203fe36d6f.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"script\",null,{\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"Organization\\\",\\\"name\\\":\\\"Faesel Saeed\\\",\\\"url\\\":\\\"https://www.faesel.com\\\",\\\"logo\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"url\\\":\\\"https://www.faesel.com/images/logo.png\\\"},\\\"sameAs\\\":[\\\"https://github.com/faeselsaeed\\\",\\\"https://www.linkedin.com/in/faesel-saeed-a97b1614\\\"]}\"}}],[\"$\",\"script\",null,{\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"WebSite\\\",\\\"name\\\":\\\"FAESEL.COM\\\",\\\"url\\\":\\\"https://www.faesel.com\\\",\\\"description\\\":\\\"A modern tech blog exploring technology, coding, and digital innovation\\\",\\\"publisher\\\":{\\\"@type\\\":\\\"Organization\\\",\\\"name\\\":\\\"Faesel Saeed\\\",\\\"url\\\":\\\"https://www.faesel.com\\\"}}\"}}]]}],[\"$\",\"body\",null,{\"children\":[[\"$\",\"$L2\",null,{\"gaId\":\"test\"}],[\"$\",\"a\",null,{\"href\":\"#main-content\",\"className\":\"skip-to-content\",\"children\":\"Skip to content\"}],[\"$\",\"$L3\",null,{}],[\"$\",\"main\",null,{\"id\":\"main-content\",\"style\":{\"minHeight\":\"70vh\"},\"children\":[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"not-found-module__HS70Aa__container\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"not-found-module__HS70Aa__title\",\"children\":\"404\"}],[\"$\",\"h2\",null,{\"className\":\"not-found-module__HS70Aa__subtitle\",\"children\":\"Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"not-found-module__HS70Aa__message\",\"children\":\"Sorry, the page you're looking for doesn't exist.\"}],[\"$\",\"$L6\",null,{\"href\":\"/\",\"className\":\"not-found-module__HS70Aa__homeLink\",\"children\":\"Go Home\"}]]}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/578ca6ed020117e9.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"footer\",null,{\"className\":\"Footer-module__S6Hkya__footer\",\"children\":[\"$\",\"div\",null,{\"className\":\"Footer-module__S6Hkya__container\",\"children\":[\"$\",\"div\",null,{\"className\":\"Footer-module__S6Hkya__content\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"Footer-module__S6Hkya__links\",\"aria-label\":\"Footer navigation\",\"children\":[[\"$\",\"$L6\",null,{\"href\":\"/blog\",\"className\":\"Footer-module__S6Hkya__link\",\"children\":\"Blog\"}],[\"$\",\"$L6\",null,{\"href\":\"/projects\",\"className\":\"Footer-module__S6Hkya__link\",\"children\":\"Projects\"}],[\"$\",\"$L6\",null,{\"href\":\"/about\",\"className\":\"Footer-module__S6Hkya__link\",\"children\":\"About\"}],[\"$\",\"$L6\",null,{\"href\":\"/contact\",\"className\":\"Footer-module__S6Hkya__link\",\"children\":\"Contact\"}]]}],[\"$\",\"p\",null,{\"className\":\"Footer-module__S6Hkya__copyright\",\"children\":[\"¬© \",2026,\" All rights reserved.\"]}]]}]}]}]]}]]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L7\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/bc2ec6988ea822be.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L8\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@a\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.Metadata\",\"children\":\"$Le\"}]}]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"10:I[5500,[\"/_next/static/chunks/8be72f203fe36d6f.js\"],\"Image\"]\n12:I[27201,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/708205fa81a1891d.js\"],\"IconMark\"]\n11:T7abc,"])</script><script>self.__next_f.push([1,"\u003cp\u003eI\u0026#39;m currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Using a queue based system for this is great because it allows us to replay any queue messages, should one of the 3rd party\u0026#39;s (or our code) fail to send the message. \u003c/p\u003e\n\u003cp\u003eSince we are connecting into 3rd party\u0026#39;s you can almost guarantee there\u0026#39;s going to be some form of failure. So its always good practice to leverage on this type of architecture to handle the unknown. We have the following setup:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWebsite¬†\u0026gt; Storage Queue¬†\u0026gt; Web Job¬†\u0026gt; Send Grid\u003c/li\u003e\n\u003cli\u003eWebsite¬†\u0026gt; Storage Queue¬†\u0026gt; Web Job¬†\u0026gt; Twillio\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWhen a failure occurs, queue messages are automatically moved from the\u003cbr\u003emessage queue into a poison queue,¬†these queues¬†are always suffixed with \u0026quot;poison\u0026quot; (MS really wanted to highlight how toxic your problems are) like so:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eemail - For normal operation\u003c/li\u003e\n\u003cli\u003eemail-poison - Messages moved here when a failure occurs\u003c/li\u003e\n\u003cli\u003esms\u003c/li\u003e\n\u003cli\u003esms-poison\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eGaining visibility of what\u0026#39;s in a poison queue is really important in knowing\u003cbr\u003ethe health of your system. So I embarked upon a task in seeking out an\u003cbr\u003ealert setting buried deep somewhere in¬†the Azure portal to help¬†surface\u003cbr\u003eany messages going into the poison queue. I knew this would be a metric\u003cbr\u003ealert of some kind either in the \u0026#39;Storage Account\u0026#39;, \u0026#39;Alerts\u0026#39; or perhaps\u003cbr\u003eeven \u0026#39;Application Insights\u0026#39; blade. \u003c/p\u003e\n\u003cp\u003eAfter having spent a while searching for it as well as posting this Stack Overflow¬†question (it wasn\u0026#39;t a popular one..), I started doubting whether it even existed!\u003c/p\u003e\n\u003cp\u003eI even tried the search box at the top of the azure dashboard as a last ditch effort, hoping it will provide answers. You think this would\u003cbr\u003eexists somewhere (if it does and my eyes have deceived me please do get\u003cbr\u003ein touch) or at the very least be visible and easily findable? Alas this was not the case..\u003c/p\u003e\n\u003cp\u003eSo I decided to do something about it, \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ewhy not have an Azure function that takes a storage account and looks through all the queues to check if any poison queue messages exist. \u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWhilst were at it we could also check if messages are stacking up in the non-poison queues (just in-case a Webjob has been turned off or cant process a certain message), and even provide the content of a problematic queue message. Since our team uses slack for communication I decided to send the notification to Slack. Below are the steps I took:\u003c/p\u003e\n\u003cp\u003e#Step 1 - Setting up slack\u003c/p\u003e\n\u003cp\u003eSetting up slack is quick and easy, just create a \u0026#39;poison-queue\u0026#39; channel, and create a new integration in the custom integrations section (Note your gonna have to get admin access to do this (I have provided a link at the bottom of this article as its nested deep in their UI). An integration is essentially a web hook endpoint for us to post JSON data to (I have added a link for Slacks JSON format below too, as well as a message builder to help customise the look and feel).\u003c/p\u003e\n\u003cp\u003eThe picture below show where you can get your web hook URL from.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"//images.ctfassets.net/wjg1udsw901v/1y3YcZQRnN6yhsilboTyhL/5c9fad66a9601cc851c9377d26198258/slackwebhook.jpg\" alt=\"Azure Queue Notifier - Slack Integration\"\u003e\u003c/p\u003e\n\u003cp\u003e#Step 2 - Create your Azure Function\u003c/p\u003e\n\u003cp\u003eSince this is not a tutorial on Azure Functions, I\u0026#39;m going to skip going into detail here. Microsoft however have provided some great documentation on this (with pictures!) to help you out. Links are at the end until MS break them. By the way your gonna need a cron expression to define the timeframe for this function to work in, if you hate cron as much as I do worry not! Use my cron expression for a daily sobering alert at 9:00 - 0 0 9 * * *\u003c/p\u003e\n\u003cp\u003e#Step 3 - Create your slack message structure\u003c/p\u003e\n\u003cp\u003eNext we can create the basic structure needed for our Slack message, expressed as a C# class. My class is actually quite simple and missing quite a few properties, to get a sense of all the customisations Slack offers have a look at the links below.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e1\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;Newtonsoft.Json\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e2\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e3\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;Attachments.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e4\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e5\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e Newtonsoft.Json;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e6\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Collections.Generic;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e7\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e8\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003esealed\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eSlackMessage\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e9\u003c/span\u003e\u003cspan class=\"line-content\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e10\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eSlackMessage\u003c/span\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e11\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e12\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        Attachments = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e List\u0026lt;Attachments\u0026gt;();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e13\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e14\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e15\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;channel\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e16\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Channel { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e17\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e18\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;username\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e19\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e UserName { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e20\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e21\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e22\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Text { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e23\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e24\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;attachments\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e25\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e List\u0026lt;Attachments\u0026gt; Attachments { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e26\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e27\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;icon_emoji\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e28\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Icon\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e29\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e30\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e { \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;:computer:\u0026quot;\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e31\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e32\u003c/span\u003e\u003cspan class=\"line-content\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e33\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e34\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;Newtonsoft.Json\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e35\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e36\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e Newtonsoft.Json;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e37\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e38\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAttachments\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e39\u003c/span\u003e\u003cspan class=\"line-content\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e40\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;color\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e41\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Colour { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e42\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e43\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e44\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Title { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e45\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e46\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    [\u003cspan class=\"hljs-meta\"\u003eJsonProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e)\u003c/span\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e47\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Text { \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e; \u003cspan class=\"hljs-keyword\"\u003eset\u003c/span\u003e; }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e48\u003c/span\u003e\u003cspan class=\"line-content\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eRemember to create these classes as .csx files for the Azure function to understand them.\u003c/p\u003e\n\u003cp\u003e#Step 4 - Create a slack client to post the message\u003c/p\u003e\n\u003cp\u003eNow that we have our message structure we can create a class to serialize and post the JSON to Slack using the Webhook created in \u003cstrong\u003eStep 1\u003c/strong\u003e, below is the code to do this,\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e1\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;Newtonsoft.Json\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e2\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;System.Web.Extensions\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e3\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;System.Web\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e4\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e5\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;SlackMessage.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e6\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;Attachments.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e7\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e8\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Net;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e9\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e Newtonsoft.Json;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e10\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Collections.Specialized;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e11\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e12\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eSlackClient\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e13\u003c/span\u003e\u003cspan class=\"line-content\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e14\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e WebHook = \u003cspan class=\"hljs-string\"\u003e@\u0026quot;https://hooks.slack.com/services/XXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXXXX\u0026quot;\u003c/span\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e15\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e16\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eSendMessage\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eSlackMessage message\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e17\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e18\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e payloadJson = JsonConvert.SerializeObject(message);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e19\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e20\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e (WebClient client = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e WebClient())\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e21\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e22\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            NameValueCollection data = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e NameValueCollection();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e23\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            data[\u003cspan class=\"hljs-string\"\u003e\u0026quot;payload\u0026quot;\u003c/span\u003e] = payloadJson;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e24\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            client.UploadValues(WebHook, \u003cspan class=\"hljs-string\"\u003e\u0026quot;POST\u0026quot;\u003c/span\u003e, data);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e25\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e26\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e27\u003c/span\u003e\u003cspan class=\"line-content\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIts good practice to move the Webhook URL into the settings file, for simplicity I have included it into this class.\u003c/p\u003e\n\u003cp\u003e#Step 5 - Queue Checker\u003c/p\u003e\n\u003cp\u003eNext we need to add code to loop through any connections string we pass it, check all the queues and send messages if we think there\u0026#39;s something wrong.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e1\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#r \u0026quot;Microsoft.WindowsAzure.Storage\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e2\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e3\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;SlackClient.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e4\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;SlackMessage.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e5\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;Attachments.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e6\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e7\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Collections.Generic;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e8\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Linq;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e9\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e Microsoft.WindowsAzure.Storage;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e10\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e Microsoft.WindowsAzure.Storage.Auth;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e11\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e12\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ePoisonQueueChecker\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e13\u003c/span\u003e\u003cspan class=\"line-content\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e14\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eCheckPoisonQueues\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eDictionary\u0026lt;\u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e, \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e\u0026gt; storageConnectionStrings\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e15\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e16\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e slackClient = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e SlackClient();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e17\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e slackMessage = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e SlackMessage { Text = \u003cspan class=\"hljs-string\"\u003e\u0026quot;Poison Queue Alerts\u0026quot;\u003c/span\u003e, Channel = \u003cspan class=\"hljs-string\"\u003e\u0026quot;poison-queue\u0026quot;\u003c/span\u003e };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e18\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e19\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        \u003cspan class=\"hljs-keyword\"\u003eforeach\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e storageConnectionString \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e storageConnectionStrings)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e20\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e21\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e storageCredentials = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e StorageCredentials(storageConnectionString.Key, storageConnectionString.Value);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e22\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e storageAccount = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e CloudStorageAccount(storageCredentials, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e23\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e queueClient = storageAccount.CreateCloudQueueClient();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e24\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e25\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e queues = queueClient.ListQueues();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e26\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003eforeach\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e queue \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e queues)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e27\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e28\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                queue.FetchAttributes();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e29\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                \u003cspan class=\"hljs-comment\"\u003e//Gets the total messages in the queue\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e30\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e queueCount = queue.ApproximateMessageCount;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e31\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e32\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queueCount \u0026gt; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e33\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e34\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e isPoisonQueue = queue.Name.EndsWith(\u003cspan class=\"hljs-string\"\u003e\u0026quot;poison\u0026quot;\u003c/span\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e35\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e attachment = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e Attachments();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e36\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    attachment.Title = \u003cspan class=\"hljs-string\"\u003e$\u0026quot;Queue: \u003cspan class=\"hljs-subst\"\u003e{queue.Name}\u003c/span\u003e, Message Count: \u003cspan class=\"hljs-subst\"\u003e{queueCount}\u003c/span\u003e\u0026quot;\u003c/span\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e37\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    attachment.Colour = isPoisonQueue ? \u003cspan class=\"hljs-string\"\u003e\u0026quot;danger\u0026quot;\u003c/span\u003e : \u003cspan class=\"hljs-string\"\u003e\u0026quot;warning\u0026quot;\u003c/span\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e38\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e39\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    \u003cspan class=\"hljs-comment\"\u003e//Note the peek function will not dequeue the message\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e40\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e message = queue.PeekMessage();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e41\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    attachment.Text = \u003cspan class=\"hljs-string\"\u003e$@\u0026quot;Insertion Time: \u003cspan class=\"hljs-subst\"\u003e{message.InsertionTime}\u003c/span\u003e, Sample Contents:\\n\u0026quot;\u003c/span\u003e +\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e42\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                                        \u003cspan class=\"hljs-string\"\u003e$\u0026quot; \u003cspan class=\"hljs-subst\"\u003e{message.AsString}\u003c/span\u003e\u0026quot;\u003c/span\u003e;                        \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e43\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e44\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                    slackMessage.Attachments.Add(attachment);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e45\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e46\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e47\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e48\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-comment\"\u003e//Add a message showing all is well\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e49\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!slackMessage.Attachments.Any())\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e50\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e51\u003c/span\u003e\u003cspan class=\"line-content\"\u003e                slackMessage.Attachments.Add(\u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e Attachments { Title = \u003cspan class=\"hljs-string\"\u003e\u0026quot;All queues are operational and empty\u0026quot;\u003c/span\u003e, Colour = \u003cspan class=\"hljs-string\"\u003e\u0026quot;good\u0026quot;\u003c/span\u003e });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e52\u003c/span\u003e\u003cspan class=\"line-content\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e53\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e54\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e55\u003c/span\u003e\u003cspan class=\"line-content\"\u003e        slackClient.SendMessage(slackMessage);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e56\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e57\u003c/span\u003e\u003cspan class=\"line-content\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e#Step 6 - Being it all together\u003c/p\u003e\n\u003cp\u003eFinal step is to hook up the functions run method like so:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e1\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-meta\"\u003e#load \u0026quot;PoisonQueueChecker.csx\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e2\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e3\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e4\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e System.Collections.Generic;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e5\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e6\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eRun\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eTimerInfo myTimer, TraceWriter log\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e7\u003c/span\u003e\u003cspan class=\"line-content\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e8\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    log.Info(\u003cspan class=\"hljs-string\"\u003e$\u0026quot;C# Timer trigger function executed at: \u003cspan class=\"hljs-subst\"\u003e{DateTime.Now}\u003c/span\u003e\u0026quot;\u003c/span\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e9\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e10\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e storageConnectionStrings = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e Dictionary();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e11\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    storageConnectionStrings.Add(\u003cspan class=\"hljs-string\"\u003e\u0026quot;storagename\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;storagekey\u0026quot;\u003c/span\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e12\u003c/span\u003e\u003cspan class=\"line-content\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e13\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e poisonQueueChecker = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e PoisonQueueChecker();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e14\u003c/span\u003e\u003cspan class=\"line-content\"\u003e    poisonQueueChecker.CheckPoisonQueues(storageConnectionStrings);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"code-line\"\u003e\u003cspan class=\"line-number\"\u003e15\u003c/span\u003e\u003cspan class=\"line-content\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAnd that\u0026#39;s it, 9 O\u0026#39;clock tomorrow you can finally start gaining visibility of those poison queues and start worrying about those dodgy lines of code causing your messages to be poisoned.\u003c/p\u003e\n\u003cp\u003e#Helpful Links\u003c/p\u003e\n\u003cp\u003eCustom Integrations\u003c/p\u003e\n\u003cp\u003ehttps://\u0026lt;\u003cyourslackgroupname\u003e\u0026gt;.slack.com/apps/manage/custom-integrations\u003c/p\u003e\n\u003cp\u003eCustomising your slack message\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://api.slack.com/docs/messages/builder\"\u003ehttps://api.slack.com/docs/messages/builder\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHow to send a slack message to your web hook:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://api.slack.com/custom-integrations/incoming-webhooks\"\u003ehttps://api.slack.com/custom-integrations/incoming-webhooks\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHow to create a azure function:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function\"\u003ehttps://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHow to code up a azure function:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp\"\u003ehttps://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp\u003c/a\u003e\u003c/p\u003e\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"script\",null,{\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"BlogPosting\\\",\\\"headline\\\":\\\"Making a Azure poison queue Slack notifier\\\",\\\"description\\\":\\\"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us\\\",\\\"image\\\":\\\"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg\\\",\\\"datePublished\\\":\\\"2017-09-23T00:00+01:00\\\",\\\"dateModified\\\":\\\"2017-09-23T00:00+01:00\\\",\\\"author\\\":{\\\"@type\\\":\\\"Person\\\",\\\"name\\\":\\\"Faesel Saeed\\\",\\\"url\\\":\\\"https://www.faesel.com/about\\\"},\\\"publisher\\\":{\\\"@type\\\":\\\"Organization\\\",\\\"name\\\":\\\"Faesel Saeed\\\",\\\"url\\\":\\\"https://www.faesel.com\\\",\\\"logo\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"url\\\":\\\"https://www.faesel.com/images/logo.png\\\"}},\\\"keywords\\\":\\\"azure, poison queue, monitoring, slack, azure-queues\\\",\\\"url\\\":\\\"https://www.faesel.com/blog/azure-poison-queue-notifier\\\",\\\"mainEntityOfPage\\\":{\\\"@type\\\":\\\"WebPage\\\",\\\"@id\\\":\\\"https://www.faesel.com/blog/azure-poison-queue-notifier\\\"}}\"}}],[\"$\",\"script\",null,{\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"BreadcrumbList\\\",\\\"itemListElement\\\":[{\\\"@type\\\":\\\"ListItem\\\",\\\"position\\\":1,\\\"name\\\":\\\"Home\\\",\\\"item\\\":\\\"https://www.faesel.com\\\"},{\\\"@type\\\":\\\"ListItem\\\",\\\"position\\\":2,\\\"name\\\":\\\"Blog\\\",\\\"item\\\":\\\"https://www.faesel.com/blog\\\"},{\\\"@type\\\":\\\"ListItem\\\",\\\"position\\\":3,\\\"name\\\":\\\"Making a Azure poison queue Slack notifier\\\",\\\"item\\\":\\\"https://www.faesel.com/blog/azure-poison-queue-notifier\\\"}]}\"}}],[\"$\",\"article\",null,{\"className\":\"page-module__dgei_G__article\",\"children\":[[\"$\",\"$L6\",null,{\"href\":\"/blog\",\"className\":\"page-module__dgei_G__backLink\",\"children\":\"‚Üê Back to Blog\"}],[\"$\",\"header\",null,{\"className\":\"page-module__dgei_G__header\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"page-module__dgei_G__title\",\"children\":\"Making a Azure poison queue Slack notifier\"}],[\"$\",\"div\",null,{\"className\":\"page-module__dgei_G__meta\",\"children\":[\"$\",\"time\",null,{\"className\":\"page-module__dgei_G__date\",\"dateTime\":\"2017-09-23T00:00+01:00\",\"children\":[\"üìÖ \",\"September 22, 2017\"]}]}],[\"$\",\"div\",null,{\"className\":\"page-module__dgei_G__tags\",\"children\":[[\"$\",\"span\",\"azure-0\",{\"className\":\"page-module__dgei_G__tag\",\"children\":\"azure\"}],[\"$\",\"span\",\"poison queue-1\",{\"className\":\"page-module__dgei_G__tag\",\"children\":\"poison queue\"}],[\"$\",\"span\",\"monitoring-2\",{\"className\":\"page-module__dgei_G__tag\",\"children\":\"monitoring\"}],[\"$\",\"span\",\"slack-3\",{\"className\":\"page-module__dgei_G__tag\",\"children\":\"slack\"}],[\"$\",\"span\",\"azure-queues-4\",{\"className\":\"page-module__dgei_G__tag\",\"children\":\"azure-queues\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"page-module__dgei_G__heroImage\",\"children\":[\"$\",\"$L10\",null,{\"src\":\"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg\",\"alt\":\"Making a Azure poison queue Slack notifier\",\"fill\":true,\"className\":\"page-module__dgei_G__heroImageImg\",\"priority\":true,\"sizes\":\"(max-width: 800px) 100vw, 800px\"}]}],[\"$\",\"div\",null,{\"className\":\"page-module__dgei_G__content\",\"dangerouslySetInnerHTML\":{\"__html\":\"$11\"}}]]}]]\n"])</script><script>self.__next_f.push([1,"a:null\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"title\",\"0\",{\"children\":\"Making a Azure poison queue Slack notifier | Tech Blog | FAESEL.COM\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us\"}],[\"$\",\"link\",\"2\",{\"rel\":\"author\",\"href\":\"https://www.faesel.com/about\"}],[\"$\",\"meta\",\"3\",{\"name\":\"author\",\"content\":\"Faesel Saeed\"}],[\"$\",\"meta\",\"4\",{\"name\":\"keywords\",\"content\":\"azure,poison queue,monitoring,slack,azure-queues\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Making a Azure poison queue Slack notifier\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:image\",\"content\":\"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"9\",{\"property\":\"article:published_time\",\"content\":\"2017-09-23T00:00+01:00\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:site\",\"content\":\"@faeselsaeed\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:creator\",\"content\":\"@faeselsaeed\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:title\",\"content\":\"Making a Azure poison queue Slack notifier\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:description\",\"content\":\"I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Us\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:image\",\"content\":\"https://images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg\"}],[\"$\",\"link\",\"16\",{\"rel\":\"shortcut icon\",\"href\":\"/favicon.ico\"}],[\"$\",\"link\",\"17\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\"}],[\"$\",\"link\",\"18\",{\"rel\":\"apple-touch-icon\",\"href\":\"/favicon.ico\"}],[\"$\",\"$L12\",\"19\",{}]]\n"])</script></body></html>