{"componentChunkName":"component---src-templates-blog-js","path":"/blog/azure-poison-queue-notifier","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://www.faesel.com"}},"contentfulBlog":{"title":"Making a Azure poison queue Slack notifier","slug":"azure-poison-queue-notifier","tags":["azure","poison queue","monitoring","slack","azure-queues"],"hero":{"file":{"url":"//images.ctfassets.net/wjg1udsw901v/UMa2shO53yjhwxv5PF0go/cbf2e4489e801053a91d77a038dcbde9/tobias-tullius-4dKy7d3lkKM-unsplash.jpg"},"title":"Azure Poison Queues Monitoring"},"datePublished":"September 22nd, 2017","iso8601DatePublished":"2017-09-22T23:00:00.000Z","bodym":{"childMarkdownRemark":{"excerpt":"I'm currently working at a place were we are using…","timeToRead":6,"html":"<p>I'm currently working at a place were we are using queue triggered Webjobs to handle the sending of messages like email and SMS (using Send Grid and Twilio). Using a queue based system for this is great because it allows us to replay any queue messages, should one of the 3rd party's (or our code) fail to send the message. </p>\n<p>Since we are connecting into 3rd party's you can almost guarantee there's going to be some form of failure. So its always good practice to leverage on this type of architecture to handle the unknown. We have the following setup:</p>\n<ul>\n<li>Website > Storage Queue > Web Job > Send Grid</li>\n<li>Website > Storage Queue > Web Job > Twillio</li>\n</ul>\n<p>When a failure occurs, queue messages are automatically moved from the\nmessage queue into a poison queue, these queues are always suffixed with \"poison\" (MS really wanted to highlight how toxic your problems are) like so:</p>\n<ul>\n<li>email - For normal operation</li>\n<li>email-poison - Messages moved here when a failure occurs</li>\n<li>sms</li>\n<li>sms-poison</li>\n</ul>\n<p>Gaining visibility of what's in a poison queue is really important in knowing\nthe health of your system. So I embarked upon a task in seeking out an\nalert setting buried deep somewhere in the Azure portal to help surface\nany messages going into the poison queue. I knew this would be a metric\nalert of some kind either in the 'Storage Account', 'Alerts' or perhaps\neven 'Application Insights' blade. </p>\n<p>After having spent a while searching for it as well as posting this Stack Overflow question (it wasn't a popular one..), I started doubting whether it even existed!</p>\n<p>I even tried the search box at the top of the azure dashboard as a last ditch effort, hoping it will provide answers. You think this would\nexists somewhere (if it does and my eyes have deceived me please do get\nin touch) or at the very least be visible and easily findable? Alas this was not the case..</p>\n<p>So I decided to do something about it, </p>\n<blockquote>\n<p>why not have an Azure function that takes a storage account and looks through all the queues to check if any poison queue messages exist. </p>\n</blockquote>\n<p>Whilst were at it we could also check if messages are stacking up in the non-poison queues (just in-case a Webjob has been turned off or cant process a certain message), and even provide the content of a problematic queue message. Since our team uses slack for communication I decided to send the notification to Slack. Below are the steps I took:</p>\n<h1>Step 1 - Setting up slack</h1>\n<p>Setting up slack is quick and easy, just create a 'poison-queue' channel, and create a new integration in the custom integrations section (Note your gonna have to get admin access to do this (I have provided a link at the bottom of this article as its nested deep in their UI). An integration is essentially a web hook endpoint for us to post JSON data to (I have added a link for Slacks JSON format below too, as well as a message builder to help customise the look and feel).</p>\n<p>The picture below show where you can get your web hook URL from.</p>\n<p><img src=\"//images.ctfassets.net/wjg1udsw901v/1y3YcZQRnN6yhsilboTyhL/5c9fad66a9601cc851c9377d26198258/slackwebhook.jpg\" alt=\"Azure Queue Notifier - Slack Integration\"></p>\n<h1>Step 2 - Create your Azure Function</h1>\n<p>Since this is not a tutorial on Azure Functions, I'm going to skip going into detail here. Microsoft however have provided some great documentation on this (with pictures!) to help you out. Links are at the end until MS break them. By the way your gonna need a cron expression to define the timeframe for this function to work in, if you hate cron as much as I do worry not! Use my cron expression for a daily sobering alert at 9:00 - 0 0 9 * * *</p>\n<h1>Step 3 - Create your slack message structure</h1>\n<p>Next we can create the basic structure needed for our Slack message, expressed as a C# class. My class is actually quite simple and missing quite a few properties, to get a sense of all the customisations Slack offers have a look at the links below.</p>\n\n        <deckgo-highlight-code language=\"csharp\"  terminal=\"carbon\" line-numbers=\"true\" >\n          <code slot=\"code\">#r &quot;Newtonsoft.Json&quot;\n\n#load &quot;Attachments.csx&quot;\n\nusing Newtonsoft.Json;\nusing System.Collections.Generic;\n\npublic sealed class SlackMessage\n{\n    public SlackMessage()\n    {\n        Attachments = new List&lt;Attachments&gt;();\n    }\n\n    [JsonProperty(&quot;channel&quot;)]\n    public string Channel { get; set; }\n\n    [JsonProperty(&quot;username&quot;)]\n    public string UserName { get; set; }\n\n    [JsonProperty(&quot;text&quot;)]\n    public string Text { get; set; }\n\n    [JsonProperty(&quot;attachments&quot;)]\n    public List&lt;Attachments&gt; Attachments { get; set; }\n\n    [JsonProperty(&quot;icon_emoji&quot;)]\n    public string Icon\n    {\n        get { return &quot;:computer:&quot;; }\n    }\n}\n\n#r &quot;Newtonsoft.Json&quot;\n\nusing Newtonsoft.Json;\n\npublic class Attachments\n{\n    [JsonProperty(&quot;color&quot;)]\n    public string Colour { get; set; }\n\n    [JsonProperty(&quot;title&quot;)]\n    public string Title { get; set; }\n\n    [JsonProperty(&quot;text&quot;)]\n    public string Text { get; set; }\n}</code>\n        </deckgo-highlight-code>\n      \n<p>Remember to create these classes as .csx files for the Azure function to understand them.</p>\n<h1>Step 4 - Create a slack client to post the message</h1>\n<p>Now that we have our message structure we can create a class to serialize and post the JSON to Slack using the Webhook created in <strong>Step 1</strong>, below is the code to do this,</p>\n\n        <deckgo-highlight-code language=\"csharp\"  terminal=\"carbon\" line-numbers=\"true\" >\n          <code slot=\"code\">#r &quot;Newtonsoft.Json&quot;\n#r &quot;System.Web.Extensions&quot;\n#r &quot;System.Web&quot;\n\n#load &quot;SlackMessage.csx&quot;\n#load &quot;Attachments.csx&quot;\n\nusing System.Net;\nusing Newtonsoft.Json;\nusing System.Collections.Specialized;\n\npublic class SlackClient\n{\n    public static readonly string WebHook = @&quot;https://hooks.slack.com/services/XXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;;\n\n    public void SendMessage(SlackMessage message)\n    {\n        string payloadJson = JsonConvert.SerializeObject(message);\n        \n        using (WebClient client = new WebClient())\n        {\n            NameValueCollection data = new NameValueCollection();\n            data[&quot;payload&quot;] = payloadJson;\n            client.UploadValues(WebHook, &quot;POST&quot;, data);\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n      \n<p>Its good practice to move the Webhook URL into the settings file, for simplicity I have included it into this class.</p>\n<h1>Step 5 - Queue Checker</h1>\n<p>Next we need to add code to loop through any connections string we pass it, check all the queues and send messages if we think there's something wrong.</p>\n\n        <deckgo-highlight-code language=\"csharp\"  terminal=\"carbon\" line-numbers=\"true\" >\n          <code slot=\"code\">#r &quot;Microsoft.WindowsAzure.Storage&quot;\n\n#load &quot;SlackClient.csx&quot;\n#load &quot;SlackMessage.csx&quot;\n#load &quot;Attachments.csx&quot;\n\nusing System.Collections.Generic;\nusing System.Linq;\nusing Microsoft.WindowsAzure.Storage;\nusing Microsoft.WindowsAzure.Storage.Auth;\n\npublic class PoisonQueueChecker\n{\n    public void CheckPoisonQueues(Dictionary&lt;string, string&gt; storageConnectionStrings)\n    {\n        var slackClient = new SlackClient();\n        var slackMessage = new SlackMessage { Text = &quot;Poison Queue Alerts&quot;, Channel = &quot;poison-queue&quot; };\n\n        foreach (var storageConnectionString in storageConnectionStrings)\n        {\n            var storageCredentials = new StorageCredentials(storageConnectionString.Key, storageConnectionString.Value);\n            var storageAccount = new CloudStorageAccount(storageCredentials, true);\n            var queueClient = storageAccount.CreateCloudQueueClient();\n\n            var queues = queueClient.ListQueues();\n            foreach (var queue in queues)\n            {\n                queue.FetchAttributes();\n                //Gets the total messages in the queue\n                var queueCount = queue.ApproximateMessageCount;\n\n                if (queueCount &gt; 0)\n                {\n                    var isPoisonQueue = queue.Name.EndsWith(&quot;poison&quot;);\n                    var attachment = new Attachments();\n                    attachment.Title = $&quot;Queue: {queue.Name}, Message Count: {queueCount}&quot;;\n                    attachment.Colour = isPoisonQueue ? &quot;danger&quot; : &quot;warning&quot;;\n\n                    //Note the peek function will not dequeue the message\n                    var message = queue.PeekMessage();\n                    attachment.Text = $@&quot;Insertion Time: {message.InsertionTime}, Sample Contents:\\n&quot; +\n                                        $&quot; {message.AsString}&quot;;                        \n\n                    slackMessage.Attachments.Add(attachment);\n                }\n            }\n\n            //Add a message showing all is well\n            if (!slackMessage.Attachments.Any())\n            {\n                slackMessage.Attachments.Add(new Attachments { Title = &quot;All queues are operational and empty&quot;, Colour = &quot;good&quot; });\n            }\n        }\n\n        slackClient.SendMessage(slackMessage);\n    }\n}</code>\n        </deckgo-highlight-code>\n      \n<h1>Step 6 - Being it all together</h1>\n<p>Final step is to hook up the functions run method like so:</p>\n\n        <deckgo-highlight-code language=\"csharp\"  terminal=\"carbon\" line-numbers=\"true\" >\n          <code slot=\"code\">#load &quot;PoisonQueueChecker.csx&quot;\n\nusing System;\nusing System.Collections.Generic;\n\npublic static void Run(TimerInfo myTimer, TraceWriter log)\n{\n    log.Info($&quot;C# Timer trigger function executed at: {DateTime.Now}&quot;);\n\n    var storageConnectionStrings = new Dictionary();\n    storageConnectionStrings.Add(&quot;storagename&quot;, &quot;storagekey&quot;);\n\n    var poisonQueueChecker = new PoisonQueueChecker();\n    poisonQueueChecker.CheckPoisonQueues(storageConnectionStrings);\n}</code>\n        </deckgo-highlight-code>\n      \n<p>And that's it, 9 O'clock tomorrow you can finally start gaining visibility of those poison queues and start worrying about those dodgy lines of code causing your messages to be poisoned.</p>\n<h1>Helpful Links</h1>\n<p>Custom Integrations</p>\n<p>https://&#x3C;<yourslackgroupname>>.slack.com/apps/manage/custom-integrations</p>\n<p>Customising your slack message</p>\n<p><a href=\"https://api.slack.com/docs/messages/builder\" target=\"_blank\" rel=\"nofollow\">https://api.slack.com/docs/messages/builder</a></p>\n<p>How to send a slack message to your web hook:</p>\n<p><a href=\"https://api.slack.com/custom-integrations/incoming-webhooks\" target=\"_blank\" rel=\"nofollow\">https://api.slack.com/custom-integrations/incoming-webhooks</a></p>\n<p>How to create a azure function:</p>\n<p><a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function\" target=\"_blank\" rel=\"nofollow\">https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function</a></p>\n<p>How to code up a azure function:</p>\n<p><a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp\" target=\"_blank\" rel=\"nofollow\">https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp</a></p>"}}}},"pageContext":{"slug":"azure-poison-queue-notifier"}}}